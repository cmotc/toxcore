\hypertarget{dns3__test_8c}{\section{testing/dns3\+\_\+test.c File Reference}
\label{dns3__test_8c}\index{testing/dns3\+\_\+test.\+c@{testing/dns3\+\_\+test.\+c}}
}
{\ttfamily \#include \char`\"{}../toxdns/toxdns.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}../toxcore/tox.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}../toxcore/network.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}misc\+\_\+tools.\+c\char`\"{}}\\*
Include dependency graph for dns3\+\_\+test.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d8/d94/dns3__test_8c__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{dns3__test_8c_a5d21ea3d7da27fbd9f40c59aaa04da62}{c\+\_\+sleep}(\hyperlink{n_tox_8c_a6150e0515f7202e2fb518f7206ed97dc}{x})~usleep(1000$\ast$\hyperlink{n_tox_8c_a6150e0515f7202e2fb518f7206ed97dc}{x})
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
uint32\+\_\+t \hyperlink{dns3__test_8c_a6256333bccad190657c1947d9764b588}{create\+\_\+packet} (uint8\+\_\+t $\ast$packet, uint8\+\_\+t $\ast$string, uint8\+\_\+t str\+\_\+len, uint8\+\_\+t id)
\item 
int \hyperlink{dns3__test_8c_a0ddf1224851353fc92bfbff6f499fa97}{main} (int argc, char $\ast$argv\mbox{[}$\,$\mbox{]})
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{dns3__test_8c_a5d21ea3d7da27fbd9f40c59aaa04da62}{\index{dns3\+\_\+test.\+c@{dns3\+\_\+test.\+c}!c\+\_\+sleep@{c\+\_\+sleep}}
\index{c\+\_\+sleep@{c\+\_\+sleep}!dns3\+\_\+test.\+c@{dns3\+\_\+test.\+c}}
\subsubsection[{c\+\_\+sleep}]{\setlength{\rightskip}{0pt plus 5cm}\#define c\+\_\+sleep(
\begin{DoxyParamCaption}
\item[{}]{{\bf x}}
\end{DoxyParamCaption}
)~usleep(1000$\ast${\bf x})}}\label{dns3__test_8c_a5d21ea3d7da27fbd9f40c59aaa04da62}


Definition at line 13 of file dns3\+\_\+test.\+c.



\subsection{Function Documentation}
\hypertarget{dns3__test_8c_a6256333bccad190657c1947d9764b588}{\index{dns3\+\_\+test.\+c@{dns3\+\_\+test.\+c}!create\+\_\+packet@{create\+\_\+packet}}
\index{create\+\_\+packet@{create\+\_\+packet}!dns3\+\_\+test.\+c@{dns3\+\_\+test.\+c}}
\subsubsection[{create\+\_\+packet}]{\setlength{\rightskip}{0pt plus 5cm}uint32\+\_\+t create\+\_\+packet (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t $\ast$}]{packet, }
\item[{uint8\+\_\+t $\ast$}]{string, }
\item[{uint8\+\_\+t}]{str\+\_\+len, }
\item[{uint8\+\_\+t}]{id}
\end{DoxyParamCaption}
)}}\label{dns3__test_8c_a6256333bccad190657c1947d9764b588}


Definition at line 17 of file dns3\+\_\+test.\+c.



References i.



Referenced by main().


\begin{DoxyCode}
18 \{
19     memset(packet, 0, str\_len + 13 + 16);
20     packet[0] = id;
21     packet[1] = rand();
22     packet[5] = 1;
23     packet[11] = 1;
24     packet[12] = \textcolor{charliteral}{'.'};
25     memcpy(packet + 13, \textcolor{keywordtype}{string}, str\_len);
26     uint32\_t \hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i}, c = 0;
27 
28     \textcolor{keywordflow}{for} (i = str\_len + 12; i != 11; --\hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i}) \{
29         \textcolor{keywordflow}{if} (packet[i] == \textcolor{charliteral}{'.'}) \{
30             packet[\hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i}] = c;
31             c = 0;
32         \} \textcolor{keywordflow}{else} \{
33             ++c;
34         \}
35     \}
36 
37     packet[str\_len + 13 + 2] = 16;
38     packet[str\_len + 13 + 4] = 1;
39     packet[str\_len + 13 + 7] = 0x29;
40     packet[str\_len + 13 + 8] = 16;
41     packet[str\_len + 13 + 12] = 0x80;
42     \textcolor{keywordflow}{return} str\_len + 13 + 16;
43 \}
\end{DoxyCode}


Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=232pt]{db/d81/dns3__test_8c_a6256333bccad190657c1947d9764b588_icgraph}
\end{center}
\end{figure}


\hypertarget{dns3__test_8c_a0ddf1224851353fc92bfbff6f499fa97}{\index{dns3\+\_\+test.\+c@{dns3\+\_\+test.\+c}!main@{main}}
\index{main@{main}!dns3\+\_\+test.\+c@{dns3\+\_\+test.\+c}}
\subsubsection[{main}]{\setlength{\rightskip}{0pt plus 5cm}int main (
\begin{DoxyParamCaption}
\item[{int}]{argc, }
\item[{char $\ast$}]{argv\mbox{[}$\,$\mbox{]}}
\end{DoxyParamCaption}
)}}\label{dns3__test_8c_a0ddf1224851353fc92bfbff6f499fa97}


Definition at line 45 of file dns3\+\_\+test.\+c.



References addr\+\_\+resolve\+\_\+or\+\_\+parse\+\_\+ip(), create\+\_\+packet(), I\+P\+::family, hex\+\_\+string\+\_\+to\+\_\+bin(), i, I\+P4\+::in\+\_\+addr, ip, I\+P\+::ip4, printf(), sock, sock\+\_\+valid(), T\+O\+X\+\_\+\+A\+D\+D\+R\+E\+S\+S\+\_\+\+S\+I\+Z\+E, tox\+\_\+decrypt\+\_\+dns3\+\_\+\+T\+X\+T(), tox\+\_\+dns3\+\_\+new(), and tox\+\_\+generate\+\_\+dns3\+\_\+string().


\begin{DoxyCode}
46 \{
47     \textcolor{keywordflow}{if} (argc < 4) \{
48         \hyperlink{toxav__many__test_8c_a1b88a4421cf9eef5af4895904ce2d905}{printf}(\textcolor{stringliteral}{"Usage: %s domain domain\_public\_key queried\_username\(\backslash\)nEX: %s utox.org
       D3154F65D28A5B41A05D4AC7E4B39C6B1C233CC857FB365C56E8392737462A12 username\(\backslash\)n"},
49                argv[0], argv[0]);
50         exit(0);
51     \}
52 
53     \hyperlink{struct_i_p}{IP} \hyperlink{irc__syncbot_8c_ae81515e082f9bc33e8968181945586da}{ip} = \{0\};
54     ip.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} = AF\_INET;
55     \hyperlink{network_8h_ae5faf8a8d23da59c3e3025a62039d8c1}{sock\_t} \hyperlink{irc__syncbot_8c_a5903d0b282fc5eae503de618f896b5e1}{sock} = \hyperlink{namespacesocket}{socket}(ip.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family}, SOCK\_DGRAM, IPPROTO\_UDP);
56 
57     \textcolor{keywordflow}{if} (!\hyperlink{network_8c_a84c3240a3325cbdaaa8a206c96980cd1}{sock\_valid}(sock))
58         \textcolor{keywordflow}{return} -1;
59 
60     \textcolor{keywordflow}{if} (!\hyperlink{network_8c_a1c024648679209a12766fedc7e55d5e4}{addr\_resolve\_or\_parse\_ip}(argv[1], &ip, 0))
61         \textcolor{keywordflow}{return} -1;
62 
63     \textcolor{keyword}{struct }sockaddr\_in target;
64     \textcolor{keywordtype}{size\_t} addrsize = \textcolor{keyword}{sizeof}(\textcolor{keyword}{struct }sockaddr\_in);
65     target.sin\_family = AF\_INET;
66     target.sin\_addr = ip.\hyperlink{struct_i_p_aca19646000f55aa927406e68fc41ecf9}{ip4}.\hyperlink{union_i_p4_a5a47f63dce37e6eb6be40f022434b1c5}{in\_addr};
67     target.sin\_port = htons(53);
68 
69     uint8\_t \textcolor{keywordtype}{string}[1024] = \{0\};
70     \textcolor{keywordtype}{void} *d = \hyperlink{toxdns_8c_a0caab80768c3729d09cd6153379574c0}{tox\_dns3\_new}(\hyperlink{misc__tools_8c_aff7dee3cea854d8a56b5a29f77910f96}{hex\_string\_to\_bin}(argv[2]));
71     \textcolor{keywordtype}{unsigned} \textcolor{keywordtype}{int} \hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i};
72     uint32\_t request\_id;
73     \textcolor{comment}{/*}
74 \textcolor{comment}{    for (i = 0; i < 255; ++i) \{}
75 \textcolor{comment}{        tox\_generate\_dns3\_string(d, string, sizeof(string), &request\_id, string, i);}
76 \textcolor{comment}{        printf("%s\(\backslash\)n", string);}
77 \textcolor{comment}{    \}*/}
78     \textcolor{keywordtype}{int} len = \hyperlink{toxdns_8c_a6f93ef1f6854405e7f5badad990f12d9}{tox\_generate\_dns3\_string}(d, \textcolor{keywordtype}{string} + 1, \textcolor{keyword}{sizeof}(\textcolor{keywordtype}{string}) - 1, &
      request\_id, (uint8\_t *)argv[3], strlen(argv[3]));
79 
80     \textcolor{keywordflow}{if} (len == -1)
81         \textcolor{keywordflow}{return} -1;
82 
83     \textcolor{keywordtype}{string}[0] = \textcolor{charliteral}{'\_'};
84     memcpy(\textcolor{keywordtype}{string} + len + 1, \textcolor{stringliteral}{".\_tox."}, \textcolor{keyword}{sizeof}(\textcolor{stringliteral}{".\_tox."}));
85     memcpy((\textcolor{keywordtype}{char} *)(\textcolor{keywordtype}{string} + len + 1 + \textcolor{keyword}{sizeof}(\textcolor{stringliteral}{".\_tox."}) - 1), argv[1], strlen(argv[1]));
86     uint8\_t packet[512];
87     uint8\_t \textcolor{keywordtype}{id} = rand();
88     uint32\_t p\_len = \hyperlink{dns3__test_8c_a6256333bccad190657c1947d9764b588}{create\_packet}(packet, \textcolor{keywordtype}{string}, strlen((\textcolor{keywordtype}{char} *)\textcolor{keywordtype}{string}), \textcolor{keywordtype}{id});
89 
90     \textcolor{keywordflow}{if} (sendto(sock, (\textcolor{keywordtype}{char} *) packet, p\_len, 0, (\textcolor{keyword}{struct} sockaddr *)&target, addrsize) != p\_len)
91         \textcolor{keywordflow}{return} -1;
92 
93     uint8\_t buffer[512] = \{\};
94     \textcolor{keywordtype}{int} r\_len = recv(sock, buffer, \textcolor{keyword}{sizeof}(buffer), 0);
95 
96     \textcolor{keywordflow}{if} (r\_len < (\textcolor{keywordtype}{int})p\_len)
97         \textcolor{keywordflow}{return} -1;
98 
99     \textcolor{keywordflow}{for} (i = r\_len - 1; i != 0 && buffer[\hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i}] != \textcolor{charliteral}{'='}; --\hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i});
100 
101     uint8\_t tox\_id[\hyperlink{tox_8h_a3a8d42ad8b2803ba6d69e88aac567113}{TOX\_ADDRESS\_SIZE}];
102 
103     \textcolor{keywordflow}{if} (\hyperlink{toxdns_8c_abf411ab6dee645acc0b1f0d429690403}{tox\_decrypt\_dns3\_TXT}(d, tox\_id, buffer + i + 1, r\_len - (i + 1), request\_id) !=
       0)
104         \textcolor{keywordflow}{return} -1;
105 
106     \hyperlink{toxav__many__test_8c_a1b88a4421cf9eef5af4895904ce2d905}{printf}(\textcolor{stringliteral}{"The Tox id for username %s is:\(\backslash\)n"}, argv[3]);
107 
108     \textcolor{comment}{//unsigned int i;}
109     \textcolor{keywordflow}{for} (i = 0; i < \hyperlink{tox_8h_a3a8d42ad8b2803ba6d69e88aac567113}{TOX\_ADDRESS\_SIZE}; ++\hyperlink{toxav__many__test_8c_acb559820d9ca11295b4500f179ef6392}{i}) \{
110         \hyperlink{toxav__many__test_8c_a1b88a4421cf9eef5af4895904ce2d905}{printf}(\textcolor{stringliteral}{"%02hhX"}, tox\_id[i]);
111     \}
112 
113     \hyperlink{toxav__many__test_8c_a1b88a4421cf9eef5af4895904ce2d905}{printf}(\textcolor{stringliteral}{"\(\backslash\)n"});
114     \textcolor{keywordflow}{return} 0;
115 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{db/d81/dns3__test_8c_a0ddf1224851353fc92bfbff6f499fa97_cgraph}
\end{center}
\end{figure}


