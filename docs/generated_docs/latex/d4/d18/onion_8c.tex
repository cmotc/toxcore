\hypertarget{onion_8c}{\section{toxcore/onion.c File Reference}
\label{onion_8c}\index{toxcore/onion.\+c@{toxcore/onion.\+c}}
}
{\ttfamily \#include \char`\"{}onion.\+h\char`\"{}}\\*
{\ttfamily \#include \char`\"{}util.\+h\char`\"{}}\\*
Include dependency graph for onion.\+c\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{dd/d7e/onion_8c__incl}
\end{center}
\end{figure}
\subsection*{Macros}
\begin{DoxyCompactItemize}
\item 
\#define \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{R\+E\+T\+U\+R\+N\+\_\+1}~\hyperlink{onion_8h_a45874dbad3133dc676900407c0672660}{O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+1}
\item 
\#define \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{R\+E\+T\+U\+R\+N\+\_\+2}~\hyperlink{onion_8h_a6c5f216c5efb2bf4097d42378d3f7afc}{O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+2}
\item 
\#define \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{R\+E\+T\+U\+R\+N\+\_\+3}~\hyperlink{onion_8h_a3a333162e7c23bebfa7554654db9374e}{O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+3}
\item 
\#define \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{S\+E\+N\+D\+\_\+\+B\+A\+S\+E}~\hyperlink{onion_8h_ac078bb7fac05e43bda3ef57b9d017ab9}{O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+\+B\+A\+S\+E}
\item 
\#define \hyperlink{onion_8c_a522d6f5f9629ff14b4aded49ada7a550}{S\+E\+N\+D\+\_\+3}~\hyperlink{onion_8h_a9bbd0314179eebb50fc1773e17acedcc}{O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+3}
\item 
\#define \hyperlink{onion_8c_aa5661900101014573923ad9500868ac0}{S\+E\+N\+D\+\_\+2}~\hyperlink{onion_8h_a8fccb7f9c3804fe5b1f9f3847efa68ac}{O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+2}
\item 
\#define \hyperlink{onion_8c_aeb042381456a47261906ba91c1a6d75a}{S\+E\+N\+D\+\_\+1}~\hyperlink{onion_8h_a41398e07b064bd6f26f7cd54c6974354}{O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+1}
\item 
\#define \hyperlink{onion_8c_a1ea2fcc7c912a1df6ab0765a7f76d6f9}{K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L}~(2 $\ast$ 60 $\ast$ 60)
\end{DoxyCompactItemize}
\subsection*{Functions}
\begin{DoxyCompactItemize}
\item 
static void \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\+\_\+symmetric\+\_\+key} (\hyperlink{struct_onion}{Onion} $\ast$onion)
\item 
static void \hyperlink{onion_8c_a6b9b6abcbb6fde502e7822236a978118}{ip\+\_\+pack} (uint8\+\_\+t $\ast$data, \hyperlink{struct_i_p}{I\+P} source)
\item 
static int \hyperlink{onion_8c_a0687fad9fd17ea53d6b84a6cfc7e0d78}{ip\+\_\+unpack} (\hyperlink{struct_i_p}{I\+P} $\ast$target, const uint8\+\_\+t $\ast$data, unsigned int data\+\_\+size, \+\_\+\+Bool disable\+\_\+family\+\_\+check)
\item 
static void \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\+\_\+pack} (uint8\+\_\+t $\ast$data, const \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} $\ast$source)
\item 
static int \hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\+\_\+unpack} (\hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} $\ast$target, const uint8\+\_\+t $\ast$data, unsigned int data\+\_\+size, \+\_\+\+Bool disable\+\_\+family\+\_\+check)
\item 
int \hyperlink{onion_8c_a2637801832f6ad6ad6fce79e76565d84}{create\+\_\+onion\+\_\+path} (const \hyperlink{struct_d_h_t}{D\+H\+T} $\ast$dht, \hyperlink{struct_onion___path}{Onion\+\_\+\+Path} $\ast$new\+\_\+path, const \hyperlink{struct_node__format}{Node\+\_\+format} $\ast$nodes)
\item 
int \hyperlink{onion_8c_a0037270c6e9bca59c4e0cd118ebfa593}{onion\+\_\+path\+\_\+to\+\_\+nodes} (\hyperlink{struct_node__format}{Node\+\_\+format} $\ast$nodes, unsigned int num\+\_\+nodes, const \hyperlink{struct_onion___path}{Onion\+\_\+\+Path} $\ast$\hyperlink{tox__sync_8c_a6f50c85874ef8f3405625e5a26febbcb}{path})
\item 
int \hyperlink{onion_8c_a34cf7934690ab5336b99844383a445a8}{create\+\_\+onion\+\_\+packet} (uint8\+\_\+t $\ast$packet, uint16\+\_\+t max\+\_\+packet\+\_\+length, const \hyperlink{struct_onion___path}{Onion\+\_\+\+Path} $\ast$\hyperlink{tox__sync_8c_a6f50c85874ef8f3405625e5a26febbcb}{path}, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} dest, const uint8\+\_\+t $\ast$data, uint16\+\_\+t length)
\item 
int \hyperlink{onion_8c_ab04a946f429ee9f9e79ac83e95ec6271}{create\+\_\+onion\+\_\+packet\+\_\+tcp} (uint8\+\_\+t $\ast$packet, uint16\+\_\+t max\+\_\+packet\+\_\+length, const \hyperlink{struct_onion___path}{Onion\+\_\+\+Path} $\ast$\hyperlink{tox__sync_8c_a6f50c85874ef8f3405625e5a26febbcb}{path}, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} dest, const uint8\+\_\+t $\ast$data, uint16\+\_\+t length)
\item 
int \hyperlink{onion_8c_af06edfff31b42d31803e24fc7f47d365}{send\+\_\+onion\+\_\+packet} (\hyperlink{struct_networking___core}{Networking\+\_\+\+Core} $\ast$net, const \hyperlink{struct_onion___path}{Onion\+\_\+\+Path} $\ast$\hyperlink{tox__sync_8c_a6f50c85874ef8f3405625e5a26febbcb}{path}, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} dest, const uint8\+\_\+t $\ast$data, uint16\+\_\+t length)
\item 
int \hyperlink{onion_8c_a8d81f915fcff64bfe2508296d325f7d4}{send\+\_\+onion\+\_\+response} (\hyperlink{struct_networking___core}{Networking\+\_\+\+Core} $\ast$net, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} dest, const uint8\+\_\+t $\ast$data, uint16\+\_\+t length, const uint8\+\_\+t $\ast$ret)
\item 
static int \hyperlink{onion_8c_ad1a4dfd05094ff479cda552ed94059f7}{handle\+\_\+send\+\_\+initial} (void $\ast$object, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$packet, uint16\+\_\+t length)
\item 
int \hyperlink{onion_8c_a112ff3dd6d8a1e104516eb4b465fc2fa}{onion\+\_\+send\+\_\+1} (const \hyperlink{struct_onion}{Onion} $\ast$onion, const uint8\+\_\+t $\ast$plain, uint16\+\_\+t len, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$\hyperlink{onion__test_8c_af73a4a6ff6a4878d8eae4ec38ffeaac2}{nonce})
\item 
static int \hyperlink{onion_8c_af8b808b43786292e39b10d6e05ba1cb7}{handle\+\_\+send\+\_\+1} (void $\ast$object, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$packet, uint16\+\_\+t length)
\item 
static int \hyperlink{onion_8c_a60a847c1f3f33f8e2efdc13ede5f7ecc}{handle\+\_\+send\+\_\+2} (void $\ast$object, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$packet, uint16\+\_\+t length)
\item 
static int \hyperlink{onion_8c_aad67ae9de051b78358faf690eaa03099}{handle\+\_\+recv\+\_\+3} (void $\ast$object, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$packet, uint16\+\_\+t length)
\item 
static int \hyperlink{onion_8c_a2efffc024cccd53f433718980ccf4541}{handle\+\_\+recv\+\_\+2} (void $\ast$object, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$packet, uint16\+\_\+t length)
\item 
static int \hyperlink{onion_8c_a733219ca8d321d01a999f10447b2e301}{handle\+\_\+recv\+\_\+1} (void $\ast$object, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port} source, const uint8\+\_\+t $\ast$packet, uint16\+\_\+t length)
\item 
void \hyperlink{onion_8c_ae1b8e562e22bd28deca3f98dace1a421}{set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1} (\hyperlink{struct_onion}{Onion} $\ast$onion, int($\ast$function)(void $\ast$, \hyperlink{struct_i_p___port}{I\+P\+\_\+\+Port}, const uint8\+\_\+t $\ast$, uint16\+\_\+t), void $\ast$object)
\item 
\hyperlink{struct_onion}{Onion} $\ast$ \hyperlink{onion_8c_a71877ec5931feec418ed1ae10b0963d8}{new\+\_\+onion} (\hyperlink{struct_d_h_t}{D\+H\+T} $\ast$dht)
\item 
void \hyperlink{onion_8c_a301c5cb9db2604dc1ea885c3a2cf8408}{kill\+\_\+onion} (\hyperlink{struct_onion}{Onion} $\ast$onion)
\end{DoxyCompactItemize}


\subsection{Macro Definition Documentation}
\hypertarget{onion_8c_a1ea2fcc7c912a1df6ab0765a7f76d6f9}{\index{onion.\+c@{onion.\+c}!K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L@{K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L}}
\index{K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L@{K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L}!onion.\+c@{onion.\+c}}
\subsubsection[{K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L}]{\setlength{\rightskip}{0pt plus 5cm}\#define K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L~(2 $\ast$ 60 $\ast$ 60)}}\label{onion_8c_a1ea2fcc7c912a1df6ab0765a7f76d6f9}


Definition at line 39 of file onion.\+c.



Referenced by change\+\_\+symmetric\+\_\+key().

\hypertarget{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{\index{onion.\+c@{onion.\+c}!R\+E\+T\+U\+R\+N\+\_\+1@{R\+E\+T\+U\+R\+N\+\_\+1}}
\index{R\+E\+T\+U\+R\+N\+\_\+1@{R\+E\+T\+U\+R\+N\+\_\+1}!onion.\+c@{onion.\+c}}
\subsubsection[{R\+E\+T\+U\+R\+N\+\_\+1}]{\setlength{\rightskip}{0pt plus 5cm}\#define R\+E\+T\+U\+R\+N\+\_\+1~{\bf O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+1}}}\label{onion_8c_a3ec5d6001e3f6782a68417d611766b33}


Definition at line 29 of file onion.\+c.



Referenced by handle\+\_\+recv\+\_\+1(), handle\+\_\+recv\+\_\+2(), and handle\+\_\+send\+\_\+1().

\hypertarget{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{\index{onion.\+c@{onion.\+c}!R\+E\+T\+U\+R\+N\+\_\+2@{R\+E\+T\+U\+R\+N\+\_\+2}}
\index{R\+E\+T\+U\+R\+N\+\_\+2@{R\+E\+T\+U\+R\+N\+\_\+2}!onion.\+c@{onion.\+c}}
\subsubsection[{R\+E\+T\+U\+R\+N\+\_\+2}]{\setlength{\rightskip}{0pt plus 5cm}\#define R\+E\+T\+U\+R\+N\+\_\+2~{\bf O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+2}}}\label{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}


Definition at line 30 of file onion.\+c.



Referenced by handle\+\_\+recv\+\_\+2(), handle\+\_\+recv\+\_\+3(), handle\+\_\+send\+\_\+1(), and handle\+\_\+send\+\_\+2().

\hypertarget{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{\index{onion.\+c@{onion.\+c}!R\+E\+T\+U\+R\+N\+\_\+3@{R\+E\+T\+U\+R\+N\+\_\+3}}
\index{R\+E\+T\+U\+R\+N\+\_\+3@{R\+E\+T\+U\+R\+N\+\_\+3}!onion.\+c@{onion.\+c}}
\subsubsection[{R\+E\+T\+U\+R\+N\+\_\+3}]{\setlength{\rightskip}{0pt plus 5cm}\#define R\+E\+T\+U\+R\+N\+\_\+3~{\bf O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+3}}}\label{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}


Definition at line 31 of file onion.\+c.



Referenced by handle\+\_\+recv\+\_\+3(), handle\+\_\+send\+\_\+2(), and send\+\_\+onion\+\_\+response().

\hypertarget{onion_8c_aeb042381456a47261906ba91c1a6d75a}{\index{onion.\+c@{onion.\+c}!S\+E\+N\+D\+\_\+1@{S\+E\+N\+D\+\_\+1}}
\index{S\+E\+N\+D\+\_\+1@{S\+E\+N\+D\+\_\+1}!onion.\+c@{onion.\+c}}
\subsubsection[{S\+E\+N\+D\+\_\+1}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+E\+N\+D\+\_\+1~{\bf O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+1}}}\label{onion_8c_aeb042381456a47261906ba91c1a6d75a}


Definition at line 36 of file onion.\+c.



Referenced by create\+\_\+onion\+\_\+packet(), and handle\+\_\+send\+\_\+initial().

\hypertarget{onion_8c_aa5661900101014573923ad9500868ac0}{\index{onion.\+c@{onion.\+c}!S\+E\+N\+D\+\_\+2@{S\+E\+N\+D\+\_\+2}}
\index{S\+E\+N\+D\+\_\+2@{S\+E\+N\+D\+\_\+2}!onion.\+c@{onion.\+c}}
\subsubsection[{S\+E\+N\+D\+\_\+2}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+E\+N\+D\+\_\+2~{\bf O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+2}}}\label{onion_8c_aa5661900101014573923ad9500868ac0}


Definition at line 35 of file onion.\+c.



Referenced by handle\+\_\+send\+\_\+1().

\hypertarget{onion_8c_a522d6f5f9629ff14b4aded49ada7a550}{\index{onion.\+c@{onion.\+c}!S\+E\+N\+D\+\_\+3@{S\+E\+N\+D\+\_\+3}}
\index{S\+E\+N\+D\+\_\+3@{S\+E\+N\+D\+\_\+3}!onion.\+c@{onion.\+c}}
\subsubsection[{S\+E\+N\+D\+\_\+3}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+E\+N\+D\+\_\+3~{\bf O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+3}}}\label{onion_8c_a522d6f5f9629ff14b4aded49ada7a550}


Definition at line 34 of file onion.\+c.



Referenced by handle\+\_\+send\+\_\+2().

\hypertarget{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{\index{onion.\+c@{onion.\+c}!S\+E\+N\+D\+\_\+\+B\+A\+S\+E@{S\+E\+N\+D\+\_\+\+B\+A\+S\+E}}
\index{S\+E\+N\+D\+\_\+\+B\+A\+S\+E@{S\+E\+N\+D\+\_\+\+B\+A\+S\+E}!onion.\+c@{onion.\+c}}
\subsubsection[{S\+E\+N\+D\+\_\+\+B\+A\+S\+E}]{\setlength{\rightskip}{0pt plus 5cm}\#define S\+E\+N\+D\+\_\+\+B\+A\+S\+E~{\bf O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+\+B\+A\+S\+E}}}\label{onion_8c_ad40bb79953288e33ace996a24cc7c86f}


Definition at line 33 of file onion.\+c.



Referenced by create\+\_\+onion\+\_\+packet(), create\+\_\+onion\+\_\+packet\+\_\+tcp(), and onion\+\_\+send\+\_\+1().



\subsection{Function Documentation}
\hypertarget{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{\index{onion.\+c@{onion.\+c}!change\+\_\+symmetric\+\_\+key@{change\+\_\+symmetric\+\_\+key}}
\index{change\+\_\+symmetric\+\_\+key@{change\+\_\+symmetric\+\_\+key}!onion.\+c@{onion.\+c}}
\subsubsection[{change\+\_\+symmetric\+\_\+key}]{\setlength{\rightskip}{0pt plus 5cm}static void change\+\_\+symmetric\+\_\+key (
\begin{DoxyParamCaption}
\item[{{\bf Onion} $\ast$}]{onion}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}


Definition at line 40 of file onion.\+c.



References is\+\_\+timeout(), K\+E\+Y\+\_\+\+R\+E\+F\+R\+E\+S\+H\+\_\+\+I\+N\+T\+E\+R\+V\+A\+L, new\+\_\+symmetric\+\_\+key(), Onion\+::secret\+\_\+symmetric\+\_\+key, Onion\+::timestamp, and unix\+\_\+time().



Referenced by handle\+\_\+recv\+\_\+1(), handle\+\_\+recv\+\_\+2(), handle\+\_\+recv\+\_\+3(), handle\+\_\+send\+\_\+1(), handle\+\_\+send\+\_\+2(), and handle\+\_\+send\+\_\+initial().


\begin{DoxyCode}
41 \{
42     \textcolor{keywordflow}{if} (\hyperlink{util_8c_ab643c84141e04b54ba650c50165ba288}{is\_timeout}(onion->\hyperlink{struct_onion_a465bef81f6478756e5443025b1f2ddfa}{timestamp}, \hyperlink{onion_8c_a1ea2fcc7c912a1df6ab0765a7f76d6f9}{KEY\_REFRESH\_INTERVAL})) \{
43         \hyperlink{crypto__core_8c_a89b4a1a4a7d8bfabdf0e1b60f074e531}{new\_symmetric\_key}(onion->\hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key});
44         onion->\hyperlink{struct_onion_a465bef81f6478756e5443025b1f2ddfa}{timestamp} = \hyperlink{util_8c_ac958d9f8847cb8039444bfa3d304233a}{unix\_time}();
45     \}
46 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a34cf7934690ab5336b99844383a445a8}{\index{onion.\+c@{onion.\+c}!create\+\_\+onion\+\_\+packet@{create\+\_\+onion\+\_\+packet}}
\index{create\+\_\+onion\+\_\+packet@{create\+\_\+onion\+\_\+packet}!onion.\+c@{onion.\+c}}
\subsubsection[{create\+\_\+onion\+\_\+packet}]{\setlength{\rightskip}{0pt plus 5cm}int create\+\_\+onion\+\_\+packet (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{max\+\_\+packet\+\_\+length, }
\item[{const {\bf Onion\+\_\+\+Path} $\ast$}]{path, }
\item[{{\bf I\+P\+\_\+\+Port}}]{dest, }
\item[{const uint8\+\_\+t $\ast$}]{data, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)}}\label{onion_8c_a34cf7934690ab5336b99844383a445a8}


Definition at line 173 of file onion.\+c.



References encrypt\+\_\+data\+\_\+symmetric(), Onion\+\_\+\+Path\+::ip\+\_\+port2, Onion\+\_\+\+Path\+::ip\+\_\+port3, ipport\+\_\+pack(), N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+\+I\+N\+I\+T\+I\+A\+L, nonce, Onion\+\_\+\+Path\+::public\+\_\+key1, Onion\+\_\+\+Path\+::public\+\_\+key2, Onion\+\_\+\+Path\+::public\+\_\+key3, random\+\_\+nonce(), S\+E\+N\+D\+\_\+1, S\+E\+N\+D\+\_\+\+B\+A\+S\+E, Onion\+\_\+\+Path\+::shared\+\_\+key1, Onion\+\_\+\+Path\+::shared\+\_\+key2, Onion\+\_\+\+Path\+::shared\+\_\+key3, and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by send\+\_\+announce\+\_\+request(), send\+\_\+data\+\_\+request(), send\+\_\+onion\+\_\+packet(), and send\+\_\+onion\+\_\+packet\+\_\+tcp\+\_\+udp().


\begin{DoxyCode}
175 \{
176     \textcolor{keywordflow}{if} (1 + length + \hyperlink{onion_8c_aeb042381456a47261906ba91c1a6d75a}{SEND\_1} > max\_packet\_length || length == 0)
177         \textcolor{keywordflow}{return} -1;
178 
179     uint8\_t step1[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + length];
180 
181     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(step1, &dest);
182     memcpy(step1 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}, length);
183 
184     uint8\_t \hyperlink{crypto__test_8c_a7932c523f7065073a396e571319201ce}{nonce}[crypto\_box\_NONCEBYTES];
185     \hyperlink{crypto__core_8c_a15ef255ab026d4881a16b99148b05dd7}{random\_nonce}(nonce);
186 
187     uint8\_t step2[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} + length];
188     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(step2, &path->\hyperlink{struct_onion___path_aef20a4d17084ae724f2e496f8f7a106a}{ip\_port3});
189     memcpy(step2 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, path->\hyperlink{struct_onion___path_a0fa442ed05e4279ea8bcb1d039724f2b}{public\_key3}, crypto\_box\_PUBLICKEYBYTES);
190 
191     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(path->\hyperlink{struct_onion___path_ab9b6dd504522fbbb77500ab7e5d27121}{shared\_key3}, nonce, step1, \textcolor{keyword}{
      sizeof}(step1),
192                                      step2 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + crypto\_box\_PUBLICKEYBYTES);
193 
194     \textcolor{keywordflow}{if} (len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + length + crypto\_box\_MACBYTES)
195         \textcolor{keywordflow}{return} -1;
196 
197     uint8\_t step3[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} * 2 + length];
198     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(step3, &path->\hyperlink{struct_onion___path_adcf789584e4efc296bc6f915d3e2e9f9}{ip\_port2});
199     memcpy(step3 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, path->\hyperlink{struct_onion___path_adb351a6df6a87dbb748077bd8081270d}{public\_key2}, crypto\_box\_PUBLICKEYBYTES);
200     len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(path->\hyperlink{struct_onion___path_a677ff69e40fecc070cfe5ebe1f4ecb71}{shared\_key2}, nonce, step2, \textcolor{keyword}{sizeof}(
      step2),
201                                  step3 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + crypto\_box\_PUBLICKEYBYTES);
202 
203     \textcolor{keywordflow}{if} (len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} + length + crypto\_box\_MACBYTES)
204         \textcolor{keywordflow}{return} -1;
205 
206     packet[0] = \hyperlink{network_8h_a6d89eb02b93f686802f9d3e5e7f7ab2d}{NET\_PACKET\_ONION\_SEND\_INITIAL};
207     memcpy(packet + 1, nonce, crypto\_box\_NONCEBYTES);
208     memcpy(packet + 1 + crypto\_box\_NONCEBYTES, path->\hyperlink{struct_onion___path_a203561e286f807c2f057fc6bce17e2d8}{public\_key1}, crypto\_box\_PUBLICKEYBYTES);
209 
210     len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(path->\hyperlink{struct_onion___path_ac38c2cdd308cce10c53e276cb664c644}{shared\_key1}, nonce, step3, \textcolor{keyword}{sizeof}(
      step3),
211                                  packet + 1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES);
212 
213     \textcolor{keywordflow}{if} (len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} * 2 + length + crypto\_box\_MACBYTES)
214         \textcolor{keywordflow}{return} -1;
215 
216     \textcolor{keywordflow}{return} 1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES + len;
217 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a34cf7934690ab5336b99844383a445a8_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a34cf7934690ab5336b99844383a445a8_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_ab04a946f429ee9f9e79ac83e95ec6271}{\index{onion.\+c@{onion.\+c}!create\+\_\+onion\+\_\+packet\+\_\+tcp@{create\+\_\+onion\+\_\+packet\+\_\+tcp}}
\index{create\+\_\+onion\+\_\+packet\+\_\+tcp@{create\+\_\+onion\+\_\+packet\+\_\+tcp}!onion.\+c@{onion.\+c}}
\subsubsection[{create\+\_\+onion\+\_\+packet\+\_\+tcp}]{\setlength{\rightskip}{0pt plus 5cm}int create\+\_\+onion\+\_\+packet\+\_\+tcp (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{max\+\_\+packet\+\_\+length, }
\item[{const {\bf Onion\+\_\+\+Path} $\ast$}]{path, }
\item[{{\bf I\+P\+\_\+\+Port}}]{dest, }
\item[{const uint8\+\_\+t $\ast$}]{data, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)}}\label{onion_8c_ab04a946f429ee9f9e79ac83e95ec6271}


Definition at line 228 of file onion.\+c.



References encrypt\+\_\+data\+\_\+symmetric(), Onion\+\_\+\+Path\+::ip\+\_\+port2, Onion\+\_\+\+Path\+::ip\+\_\+port3, ipport\+\_\+pack(), nonce, Onion\+\_\+\+Path\+::public\+\_\+key2, Onion\+\_\+\+Path\+::public\+\_\+key3, random\+\_\+nonce(), S\+E\+N\+D\+\_\+\+B\+A\+S\+E, Onion\+\_\+\+Path\+::shared\+\_\+key2, Onion\+\_\+\+Path\+::shared\+\_\+key3, and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by send\+\_\+onion\+\_\+packet\+\_\+tcp\+\_\+udp().


\begin{DoxyCode}
230 \{
231     \textcolor{keywordflow}{if} (crypto\_box\_NONCEBYTES + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} * 2 + length > 
      max\_packet\_length || length == 0)
232         \textcolor{keywordflow}{return} -1;
233 
234     uint8\_t step1[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + length];
235 
236     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(step1, &dest);
237     memcpy(step1 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}, length);
238 
239     uint8\_t \hyperlink{crypto__test_8c_a7932c523f7065073a396e571319201ce}{nonce}[crypto\_box\_NONCEBYTES];
240     \hyperlink{crypto__core_8c_a15ef255ab026d4881a16b99148b05dd7}{random\_nonce}(nonce);
241 
242     uint8\_t step2[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} + length];
243     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(step2, &path->\hyperlink{struct_onion___path_aef20a4d17084ae724f2e496f8f7a106a}{ip\_port3});
244     memcpy(step2 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, path->\hyperlink{struct_onion___path_a0fa442ed05e4279ea8bcb1d039724f2b}{public\_key3}, crypto\_box\_PUBLICKEYBYTES);
245 
246     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(path->\hyperlink{struct_onion___path_ab9b6dd504522fbbb77500ab7e5d27121}{shared\_key3}, nonce, step1, \textcolor{keyword}{
      sizeof}(step1),
247                                      step2 + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + crypto\_box\_PUBLICKEYBYTES);
248 
249     \textcolor{keywordflow}{if} (len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + length + crypto\_box\_MACBYTES)
250         \textcolor{keywordflow}{return} -1;
251 
252     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(packet + crypto\_box\_NONCEBYTES, &path->\hyperlink{struct_onion___path_adcf789584e4efc296bc6f915d3e2e9f9}{ip\_port2});
253     memcpy(packet + crypto\_box\_NONCEBYTES + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, path->
      \hyperlink{struct_onion___path_adb351a6df6a87dbb748077bd8081270d}{public\_key2}, crypto\_box\_PUBLICKEYBYTES);
254     len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(path->\hyperlink{struct_onion___path_a677ff69e40fecc070cfe5ebe1f4ecb71}{shared\_key2}, nonce, step2, \textcolor{keyword}{sizeof}(
      step2),
255                                  packet + crypto\_box\_NONCEBYTES + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + 
      crypto\_box\_PUBLICKEYBYTES);
256 
257     \textcolor{keywordflow}{if} (len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} + length + crypto\_box\_MACBYTES)
258         \textcolor{keywordflow}{return} -1;
259 
260     memcpy(packet, nonce, crypto\_box\_NONCEBYTES);
261 
262     \textcolor{keywordflow}{return} crypto\_box\_NONCEBYTES + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + crypto\_box\_PUBLICKEYBYTES + len;
263 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_ab04a946f429ee9f9e79ac83e95ec6271_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_ab04a946f429ee9f9e79ac83e95ec6271_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a2637801832f6ad6ad6fce79e76565d84}{\index{onion.\+c@{onion.\+c}!create\+\_\+onion\+\_\+path@{create\+\_\+onion\+\_\+path}}
\index{create\+\_\+onion\+\_\+path@{create\+\_\+onion\+\_\+path}!onion.\+c@{onion.\+c}}
\subsubsection[{create\+\_\+onion\+\_\+path}]{\setlength{\rightskip}{0pt plus 5cm}int create\+\_\+onion\+\_\+path (
\begin{DoxyParamCaption}
\item[{const {\bf D\+H\+T} $\ast$}]{dht, }
\item[{{\bf Onion\+\_\+\+Path} $\ast$}]{new\+\_\+path, }
\item[{const {\bf Node\+\_\+format} $\ast$}]{nodes}
\end{DoxyParamCaption}
)}}\label{onion_8c_a2637801832f6ad6ad6fce79e76565d84}


Definition at line 114 of file onion.\+c.



References encrypt\+\_\+precompute(), Node\+\_\+format\+::ip\+\_\+port, Onion\+\_\+\+Path\+::ip\+\_\+port1, Onion\+\_\+\+Path\+::ip\+\_\+port2, Onion\+\_\+\+Path\+::ip\+\_\+port3, Onion\+\_\+\+Path\+::node\+\_\+public\+\_\+key1, Onion\+\_\+\+Path\+::node\+\_\+public\+\_\+key2, Onion\+\_\+\+Path\+::node\+\_\+public\+\_\+key3, make-\/funny-\/savefile\+::public\+\_\+key, Node\+\_\+format\+::public\+\_\+key, Onion\+\_\+\+Path\+::public\+\_\+key1, Onion\+\_\+\+Path\+::public\+\_\+key2, Onion\+\_\+\+Path\+::public\+\_\+key3, D\+H\+T\+::self\+\_\+public\+\_\+key, D\+H\+T\+::self\+\_\+secret\+\_\+key, Onion\+\_\+\+Path\+::shared\+\_\+key1, Onion\+\_\+\+Path\+::shared\+\_\+key2, and Onion\+\_\+\+Path\+::shared\+\_\+key3.



Referenced by random\+\_\+path(), and S\+T\+A\+R\+T\+\_\+\+T\+E\+S\+T().


\begin{DoxyCode}
115 \{
116     \textcolor{keywordflow}{if} (!new\_path || !nodes)
117         \textcolor{keywordflow}{return} -1;
118 
119     \hyperlink{crypto__core_8c_a0d8eaef49981c5dc3ada078866b42f6d}{encrypt\_precompute}(nodes[0].\hyperlink{namespacemake-funny-savefile_a6734667aeff5c30ad9e5624ccb556a87}{public\_key}, dht->
      \hyperlink{struct_d_h_t_aa05050f86513ff53fe9da81f73c72267}{self\_secret\_key}, new\_path->\hyperlink{struct_onion___path_ac38c2cdd308cce10c53e276cb664c644}{shared\_key1});
120     memcpy(new\_path->\hyperlink{struct_onion___path_a203561e286f807c2f057fc6bce17e2d8}{public\_key1}, dht->\hyperlink{struct_d_h_t_ae726df8bdc26380e5a6c3187a00d6881}{self\_public\_key}, crypto\_box\_PUBLICKEYBYTES
      );
121 
122     uint8\_t random\_public\_key[crypto\_box\_PUBLICKEYBYTES];
123     uint8\_t random\_secret\_key[crypto\_box\_SECRETKEYBYTES];
124 
125     crypto\_box\_keypair(random\_public\_key, random\_secret\_key);
126     \hyperlink{crypto__core_8c_a0d8eaef49981c5dc3ada078866b42f6d}{encrypt\_precompute}(nodes[1].\hyperlink{namespacemake-funny-savefile_a6734667aeff5c30ad9e5624ccb556a87}{public\_key}, random\_secret\_key, new\_path->
      \hyperlink{struct_onion___path_a677ff69e40fecc070cfe5ebe1f4ecb71}{shared\_key2});
127     memcpy(new\_path->\hyperlink{struct_onion___path_adb351a6df6a87dbb748077bd8081270d}{public\_key2}, random\_public\_key, crypto\_box\_PUBLICKEYBYTES);
128 
129     crypto\_box\_keypair(random\_public\_key, random\_secret\_key);
130     \hyperlink{crypto__core_8c_a0d8eaef49981c5dc3ada078866b42f6d}{encrypt\_precompute}(nodes[2].\hyperlink{namespacemake-funny-savefile_a6734667aeff5c30ad9e5624ccb556a87}{public\_key}, random\_secret\_key, new\_path->
      \hyperlink{struct_onion___path_ab9b6dd504522fbbb77500ab7e5d27121}{shared\_key3});
131     memcpy(new\_path->\hyperlink{struct_onion___path_a0fa442ed05e4279ea8bcb1d039724f2b}{public\_key3}, random\_public\_key, crypto\_box\_PUBLICKEYBYTES);
132 
133     new\_path->\hyperlink{struct_onion___path_ad7670c0a1a9d05b2a807a9c1a7950b79}{ip\_port1} = nodes[0].\hyperlink{struct_node__format_a86e2a5a56c0dd22df6e8b8a10e40f9e4}{ip\_port};
134     new\_path->\hyperlink{struct_onion___path_adcf789584e4efc296bc6f915d3e2e9f9}{ip\_port2} = nodes[1].\hyperlink{struct_node__format_a86e2a5a56c0dd22df6e8b8a10e40f9e4}{ip\_port};
135     new\_path->\hyperlink{struct_onion___path_aef20a4d17084ae724f2e496f8f7a106a}{ip\_port3} = nodes[2].\hyperlink{struct_node__format_a86e2a5a56c0dd22df6e8b8a10e40f9e4}{ip\_port};
136 
137     memcpy(new\_path->\hyperlink{struct_onion___path_a38f4e3f7780648cf74f808d7942113d8}{node\_public\_key1}, nodes[0].\hyperlink{struct_node__format_aaa806bb1136fb3d4b5d8d8970b596ff7}{public\_key}, 
      crypto\_box\_PUBLICKEYBYTES);
138     memcpy(new\_path->\hyperlink{struct_onion___path_adc5a9730c2f43085e83ece3257af154a}{node\_public\_key2}, nodes[1].\hyperlink{struct_node__format_aaa806bb1136fb3d4b5d8d8970b596ff7}{public\_key}, 
      crypto\_box\_PUBLICKEYBYTES);
139     memcpy(new\_path->\hyperlink{struct_onion___path_a4725b29fc0349714fa0ab0938844cf19}{node\_public\_key3}, nodes[2].\hyperlink{struct_node__format_aaa806bb1136fb3d4b5d8d8970b596ff7}{public\_key}, 
      crypto\_box\_PUBLICKEYBYTES);
140 
141     \textcolor{keywordflow}{return} 0;
142 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=317pt]{d4/d18/onion_8c_a2637801832f6ad6ad6fce79e76565d84_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a2637801832f6ad6ad6fce79e76565d84_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a733219ca8d321d01a999f10447b2e301}{\index{onion.\+c@{onion.\+c}!handle\+\_\+recv\+\_\+1@{handle\+\_\+recv\+\_\+1}}
\index{handle\+\_\+recv\+\_\+1@{handle\+\_\+recv\+\_\+1}!onion.\+c@{onion.\+c}}
\subsubsection[{handle\+\_\+recv\+\_\+1}]{\setlength{\rightskip}{0pt plus 5cm}static int handle\+\_\+recv\+\_\+1 (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{object, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_a733219ca8d321d01a999f10447b2e301}


Definition at line 541 of file onion.\+c.



References Onion\+::callback\+\_\+object, change\+\_\+symmetric\+\_\+key(), decrypt\+\_\+data\+\_\+symmetric(), I\+P\+::family, I\+P\+\_\+\+Port\+::ip, ipport\+\_\+unpack(), Onion\+::net, O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, Onion\+::recv\+\_\+1\+\_\+function, R\+E\+T\+U\+R\+N\+\_\+1, Onion\+::secret\+\_\+symmetric\+\_\+key, sendpacket(), and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by new\+\_\+onion().


\begin{DoxyCode}
542 \{
543     \hyperlink{struct_onion}{Onion} *onion = object;
544 
545     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE})
546         \textcolor{keywordflow}{return} 1;
547 
548     \textcolor{keywordflow}{if} (length <= 1 + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1})
549         \textcolor{keywordflow}{return} 1;
550 
551     \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\_symmetric\_key}(onion);
552 
553     uint8\_t plain[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}];
554     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a824b257fcff74b9d17c5247223fbed29}{decrypt\_data\_symmetric}(onion->
      \hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key}, packet + 1, packet + 1 + crypto\_box\_NONCEBYTES,
555                                      \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + crypto\_box\_MACBYTES, plain);
556 
557     \textcolor{keywordflow}{if} ((uint32\_t)len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT})
558         \textcolor{keywordflow}{return} 1;
559 
560     \hyperlink{struct_i_p___port}{IP\_Port} send\_to;
561 
562     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\_unpack}(&send\_to, plain, len, 1) == -1)
563         \textcolor{keywordflow}{return} 1;
564 
565     uint16\_t data\_len = length - (1 + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1});
566 
567     \textcolor{keywordflow}{if} (onion->\hyperlink{struct_onion_a980753d0df6688333680e95f637eb7a7}{recv\_1\_function} && send\_to.\hyperlink{struct_i_p___port_a0c6193a337a223c63411b2fe722d79ec}{ip}.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} != AF\_INET && send\_to.
      \hyperlink{struct_i_p___port_a0c6193a337a223c63411b2fe722d79ec}{ip}.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} != AF\_INET6)
568         \textcolor{keywordflow}{return} onion->\hyperlink{struct_onion_a980753d0df6688333680e95f637eb7a7}{recv\_1\_function}(onion->\hyperlink{struct_onion_aa30dff385b8f119ddb95900b2a250a08}{callback\_object}, send\_to, packet
       + (1 + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1}), data\_len);
569 
570     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, send\_to, packet + (1 + 
      \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1}), data\_len) != data\_len)
571         \textcolor{keywordflow}{return} 1;
572 
573     \textcolor{keywordflow}{return} 0;
574 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a733219ca8d321d01a999f10447b2e301_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a733219ca8d321d01a999f10447b2e301_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a2efffc024cccd53f433718980ccf4541}{\index{onion.\+c@{onion.\+c}!handle\+\_\+recv\+\_\+2@{handle\+\_\+recv\+\_\+2}}
\index{handle\+\_\+recv\+\_\+2@{handle\+\_\+recv\+\_\+2}!onion.\+c@{onion.\+c}}
\subsubsection[{handle\+\_\+recv\+\_\+2}]{\setlength{\rightskip}{0pt plus 5cm}static int handle\+\_\+recv\+\_\+2 (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{object, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_a2efffc024cccd53f433718980ccf4541}


Definition at line 505 of file onion.\+c.



References change\+\_\+symmetric\+\_\+key(), make-\/funny-\/savefile\+::data, decrypt\+\_\+data\+\_\+symmetric(), ipport\+\_\+unpack(), Onion\+::net, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+1, O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, R\+E\+T\+U\+R\+N\+\_\+1, R\+E\+T\+U\+R\+N\+\_\+2, Onion\+::secret\+\_\+symmetric\+\_\+key, sendpacket(), and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by new\+\_\+onion().


\begin{DoxyCode}
506 \{
507     \hyperlink{struct_onion}{Onion} *onion = object;
508 
509     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE})
510         \textcolor{keywordflow}{return} 1;
511 
512     \textcolor{keywordflow}{if} (length <= 1 + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2})
513         \textcolor{keywordflow}{return} 1;
514 
515     \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\_symmetric\_key}(onion);
516 
517     uint8\_t plain[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1}];
518     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a824b257fcff74b9d17c5247223fbed29}{decrypt\_data\_symmetric}(onion->
      \hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key}, packet + 1, packet + 1 + crypto\_box\_NONCEBYTES,
519                                      \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1} + crypto\_box\_MACBYTES, plain
      );
520 
521     \textcolor{keywordflow}{if} ((uint32\_t)len != \textcolor{keyword}{sizeof}(plain))
522         \textcolor{keywordflow}{return} 1;
523 
524     \hyperlink{struct_i_p___port}{IP\_Port} send\_to;
525 
526     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\_unpack}(&send\_to, plain, len, 0) == -1)
527         \textcolor{keywordflow}{return} 1;
528 
529     uint8\_t \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
530     data[0] = \hyperlink{network_8h_ac2df6c149caae49d80e5217d480ae839}{NET\_PACKET\_ONION\_RECV\_1};
531     memcpy(data + 1, plain + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1});
532     memcpy(data + 1 + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1}, packet + 1 + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}, length - (1 + 
      \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}));
533     uint16\_t data\_len = 1 + \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1} + (length - (1 + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}));
534 
535     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, send\_to, data, data\_len) != data\_len)
536         \textcolor{keywordflow}{return} 1;
537 
538     \textcolor{keywordflow}{return} 0;
539 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a2efffc024cccd53f433718980ccf4541_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a2efffc024cccd53f433718980ccf4541_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_aad67ae9de051b78358faf690eaa03099}{\index{onion.\+c@{onion.\+c}!handle\+\_\+recv\+\_\+3@{handle\+\_\+recv\+\_\+3}}
\index{handle\+\_\+recv\+\_\+3@{handle\+\_\+recv\+\_\+3}!onion.\+c@{onion.\+c}}
\subsubsection[{handle\+\_\+recv\+\_\+3}]{\setlength{\rightskip}{0pt plus 5cm}static int handle\+\_\+recv\+\_\+3 (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{object, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_aad67ae9de051b78358faf690eaa03099}


Definition at line 469 of file onion.\+c.



References change\+\_\+symmetric\+\_\+key(), make-\/funny-\/savefile\+::data, decrypt\+\_\+data\+\_\+symmetric(), ipport\+\_\+unpack(), Onion\+::net, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+2, O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, R\+E\+T\+U\+R\+N\+\_\+2, R\+E\+T\+U\+R\+N\+\_\+3, Onion\+::secret\+\_\+symmetric\+\_\+key, sendpacket(), and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by new\+\_\+onion().


\begin{DoxyCode}
470 \{
471     \hyperlink{struct_onion}{Onion} *onion = object;
472 
473     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE})
474         \textcolor{keywordflow}{return} 1;
475 
476     \textcolor{keywordflow}{if} (length <= 1 + \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3})
477         \textcolor{keywordflow}{return} 1;
478 
479     \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\_symmetric\_key}(onion);
480 
481     uint8\_t plain[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}];
482     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a824b257fcff74b9d17c5247223fbed29}{decrypt\_data\_symmetric}(onion->
      \hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key}, packet + 1, packet + 1 + crypto\_box\_NONCEBYTES,
483                                      \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2} + crypto\_box\_MACBYTES, plain
      );
484 
485     \textcolor{keywordflow}{if} ((uint32\_t)len != \textcolor{keyword}{sizeof}(plain))
486         \textcolor{keywordflow}{return} 1;
487 
488     \hyperlink{struct_i_p___port}{IP\_Port} send\_to;
489 
490     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\_unpack}(&send\_to, plain, len, 0) == -1)
491         \textcolor{keywordflow}{return} 1;
492 
493     uint8\_t \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
494     data[0] = \hyperlink{network_8h_a27ee7b36bdc6b4fb72e704fee4dc392b}{NET\_PACKET\_ONION\_RECV\_2};
495     memcpy(data + 1, plain + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2});
496     memcpy(data + 1 + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}, packet + 1 + \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3}, length - (1 + 
      \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3}));
497     uint16\_t data\_len = 1 + \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2} + (length - (1 + \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3}));
498 
499     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, send\_to, data, data\_len) != data\_len)
500         \textcolor{keywordflow}{return} 1;
501 
502     \textcolor{keywordflow}{return} 0;
503 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_aad67ae9de051b78358faf690eaa03099_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_aad67ae9de051b78358faf690eaa03099_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_af8b808b43786292e39b10d6e05ba1cb7}{\index{onion.\+c@{onion.\+c}!handle\+\_\+send\+\_\+1@{handle\+\_\+send\+\_\+1}}
\index{handle\+\_\+send\+\_\+1@{handle\+\_\+send\+\_\+1}!onion.\+c@{onion.\+c}}
\subsubsection[{handle\+\_\+send\+\_\+1}]{\setlength{\rightskip}{0pt plus 5cm}static int handle\+\_\+send\+\_\+1 (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{object, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_af8b808b43786292e39b10d6e05ba1cb7}


Definition at line 370 of file onion.\+c.



References change\+\_\+symmetric\+\_\+key(), make-\/funny-\/savefile\+::data, decrypt\+\_\+data\+\_\+symmetric(), Onion\+::dht, encrypt\+\_\+data\+\_\+symmetric(), get\+\_\+shared\+\_\+key(), ipport\+\_\+pack(), ipport\+\_\+unpack(), Onion\+::net, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+2, new\+\_\+nonce(), O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, R\+E\+T\+U\+R\+N\+\_\+1, R\+E\+T\+U\+R\+N\+\_\+2, Onion\+::secret\+\_\+symmetric\+\_\+key, D\+H\+T\+::self\+\_\+secret\+\_\+key, S\+E\+N\+D\+\_\+2, sendpacket(), Onion\+::shared\+\_\+keys\+\_\+2, and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by new\+\_\+onion().


\begin{DoxyCode}
371 \{
372     \hyperlink{struct_onion}{Onion} *onion = object;
373 
374     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE})
375         \textcolor{keywordflow}{return} 1;
376 
377     \textcolor{keywordflow}{if} (length <= 1 + \hyperlink{onion_8c_aa5661900101014573923ad9500868ac0}{SEND\_2})
378         \textcolor{keywordflow}{return} 1;
379 
380     \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\_symmetric\_key}(onion);
381 
382     uint8\_t plain[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
383     uint8\_t shared\_key[crypto\_box\_BEFORENMBYTES];
384     \hyperlink{_d_h_t_8c_a6cd4aa89d7bfcf6805c5ce6b273d9e9e}{get\_shared\_key}(&onion->\hyperlink{struct_onion_a01ec0631137b85dd55bf0cbb3492e8f5}{shared\_keys\_2}, shared\_key, onion->
      \hyperlink{struct_onion_a8b3d6ce8745acc52695e252bdb1531b6}{dht}->\hyperlink{struct_d_h_t_aa05050f86513ff53fe9da81f73c72267}{self\_secret\_key}, packet + 1 + crypto\_box\_NONCEBYTES);
385     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a824b257fcff74b9d17c5247223fbed29}{decrypt\_data\_symmetric}(shared\_key, packet + 1, packet + 1 + 
      crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES,
386                                      length - (1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES + 
      \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1}), plain);
387 
388     \textcolor{keywordflow}{if} (len != length - (1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES + 
      \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1} + crypto\_box\_MACBYTES))
389         \textcolor{keywordflow}{return} 1;
390 
391     \hyperlink{struct_i_p___port}{IP\_Port} send\_to;
392 
393     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\_unpack}(&send\_to, plain, len, 0) == -1)
394         \textcolor{keywordflow}{return} 1;
395 
396     uint8\_t \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
397     data[0] = \hyperlink{network_8h_ac537a2a6be093500c4d362012515b565}{NET\_PACKET\_ONION\_SEND\_2};
398     memcpy(data + 1, packet + 1, crypto\_box\_NONCEBYTES);
399     memcpy(data + 1 + crypto\_box\_NONCEBYTES, plain + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, len - 
      \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
400     uint16\_t data\_len = 1 + crypto\_box\_NONCEBYTES + (len - \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
401     uint8\_t *ret\_part = data + data\_len;
402     \hyperlink{crypto__core_8c_a8b1033efb47c625779d11be7d8eb9e24}{new\_nonce}(ret\_part);
403     uint8\_t ret\_data[\hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1} + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}];
404     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(ret\_data, &source);
405     memcpy(ret\_data + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, packet + (length - \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1}), 
      \hyperlink{onion_8c_a3ec5d6001e3f6782a68417d611766b33}{RETURN\_1});
406     len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(onion->
      \hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key}, ret\_part, ret\_data, \textcolor{keyword}{sizeof}(ret\_data),
407                                  ret\_part + crypto\_box\_NONCEBYTES);
408 
409     \textcolor{keywordflow}{if} (len != \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2} - crypto\_box\_NONCEBYTES)
410         \textcolor{keywordflow}{return} 1;
411 
412     data\_len += crypto\_box\_NONCEBYTES + len;
413 
414     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, send\_to, data, data\_len) != data\_len)
415         \textcolor{keywordflow}{return} 1;
416 
417     \textcolor{keywordflow}{return} 0;
418 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_af8b808b43786292e39b10d6e05ba1cb7_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_af8b808b43786292e39b10d6e05ba1cb7_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a60a847c1f3f33f8e2efdc13ede5f7ecc}{\index{onion.\+c@{onion.\+c}!handle\+\_\+send\+\_\+2@{handle\+\_\+send\+\_\+2}}
\index{handle\+\_\+send\+\_\+2@{handle\+\_\+send\+\_\+2}!onion.\+c@{onion.\+c}}
\subsubsection[{handle\+\_\+send\+\_\+2}]{\setlength{\rightskip}{0pt plus 5cm}static int handle\+\_\+send\+\_\+2 (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{object, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_a60a847c1f3f33f8e2efdc13ede5f7ecc}


Definition at line 420 of file onion.\+c.



References change\+\_\+symmetric\+\_\+key(), make-\/funny-\/savefile\+::data, decrypt\+\_\+data\+\_\+symmetric(), Onion\+::dht, encrypt\+\_\+data\+\_\+symmetric(), get\+\_\+shared\+\_\+key(), ipport\+\_\+pack(), ipport\+\_\+unpack(), Onion\+::net, new\+\_\+nonce(), O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, R\+E\+T\+U\+R\+N\+\_\+2, R\+E\+T\+U\+R\+N\+\_\+3, Onion\+::secret\+\_\+symmetric\+\_\+key, D\+H\+T\+::self\+\_\+secret\+\_\+key, S\+E\+N\+D\+\_\+3, sendpacket(), Onion\+::shared\+\_\+keys\+\_\+3, and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by new\+\_\+onion().


\begin{DoxyCode}
421 \{
422     \hyperlink{struct_onion}{Onion} *onion = object;
423 
424     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE})
425         \textcolor{keywordflow}{return} 1;
426 
427     \textcolor{keywordflow}{if} (length <= 1 + \hyperlink{onion_8c_a522d6f5f9629ff14b4aded49ada7a550}{SEND\_3})
428         \textcolor{keywordflow}{return} 1;
429 
430     \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\_symmetric\_key}(onion);
431 
432     uint8\_t plain[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
433     uint8\_t shared\_key[crypto\_box\_BEFORENMBYTES];
434     \hyperlink{_d_h_t_8c_a6cd4aa89d7bfcf6805c5ce6b273d9e9e}{get\_shared\_key}(&onion->\hyperlink{struct_onion_a2c2de8d3552fa4223cbf58557704b977}{shared\_keys\_3}, shared\_key, onion->
      \hyperlink{struct_onion_a8b3d6ce8745acc52695e252bdb1531b6}{dht}->\hyperlink{struct_d_h_t_aa05050f86513ff53fe9da81f73c72267}{self\_secret\_key}, packet + 1 + crypto\_box\_NONCEBYTES);
435     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a824b257fcff74b9d17c5247223fbed29}{decrypt\_data\_symmetric}(shared\_key, packet + 1, packet + 1 + 
      crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES,
436                                      length - (1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES + 
      \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}), plain);
437 
438     \textcolor{keywordflow}{if} (len != length - (1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES + 
      \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2} + crypto\_box\_MACBYTES))
439         \textcolor{keywordflow}{return} 1;
440 
441     \hyperlink{struct_i_p___port}{IP\_Port} send\_to;
442 
443     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\_unpack}(&send\_to, plain, len, 0) == -1)
444         \textcolor{keywordflow}{return} 1;
445 
446     uint8\_t \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
447     memcpy(data, plain + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, len - \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
448     uint16\_t data\_len = (len - \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
449     uint8\_t *ret\_part = data + (len - \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
450     \hyperlink{crypto__core_8c_a8b1033efb47c625779d11be7d8eb9e24}{new\_nonce}(ret\_part);
451     uint8\_t ret\_data[\hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2} + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}];
452     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(ret\_data, &source);
453     memcpy(ret\_data + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, packet + (length - \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2}), 
      \hyperlink{onion_8c_a64cc5b4502d2340d490ddd14779f9c6b}{RETURN\_2});
454     len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(onion->
      \hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key}, ret\_part, ret\_data, \textcolor{keyword}{sizeof}(ret\_data),
455                                  ret\_part + crypto\_box\_NONCEBYTES);
456 
457     \textcolor{keywordflow}{if} (len != \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3} - crypto\_box\_NONCEBYTES)
458         \textcolor{keywordflow}{return} 1;
459 
460     data\_len += \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3};
461 
462     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, send\_to, data, data\_len) != data\_len)
463         \textcolor{keywordflow}{return} 1;
464 
465     \textcolor{keywordflow}{return} 0;
466 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a60a847c1f3f33f8e2efdc13ede5f7ecc_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a60a847c1f3f33f8e2efdc13ede5f7ecc_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_ad1a4dfd05094ff479cda552ed94059f7}{\index{onion.\+c@{onion.\+c}!handle\+\_\+send\+\_\+initial@{handle\+\_\+send\+\_\+initial}}
\index{handle\+\_\+send\+\_\+initial@{handle\+\_\+send\+\_\+initial}!onion.\+c@{onion.\+c}}
\subsubsection[{handle\+\_\+send\+\_\+initial}]{\setlength{\rightskip}{0pt plus 5cm}static int handle\+\_\+send\+\_\+initial (
\begin{DoxyParamCaption}
\item[{void $\ast$}]{object, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{packet, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_ad1a4dfd05094ff479cda552ed94059f7}


Definition at line 309 of file onion.\+c.



References change\+\_\+symmetric\+\_\+key(), decrypt\+\_\+data\+\_\+symmetric(), Onion\+::dht, get\+\_\+shared\+\_\+key(), O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, onion\+\_\+send\+\_\+1(), D\+H\+T\+::self\+\_\+secret\+\_\+key, S\+E\+N\+D\+\_\+1, and Onion\+::shared\+\_\+keys\+\_\+1.



Referenced by new\+\_\+onion().


\begin{DoxyCode}
310 \{
311     \hyperlink{struct_onion}{Onion} *onion = object;
312 
313     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE})
314         \textcolor{keywordflow}{return} 1;
315 
316     \textcolor{keywordflow}{if} (length <= 1 + \hyperlink{onion_8c_aeb042381456a47261906ba91c1a6d75a}{SEND\_1})
317         \textcolor{keywordflow}{return} 1;
318 
319     \hyperlink{onion_8c_aa1c4b4ce8c4a67cd1590892ee6ed57c7}{change\_symmetric\_key}(onion);
320 
321     uint8\_t plain[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
322     uint8\_t shared\_key[crypto\_box\_BEFORENMBYTES];
323     \hyperlink{_d_h_t_8c_a6cd4aa89d7bfcf6805c5ce6b273d9e9e}{get\_shared\_key}(&onion->\hyperlink{struct_onion_a7dc1514173e0fd82d265ebc3a43090ea}{shared\_keys\_1}, shared\_key, onion->
      \hyperlink{struct_onion_a8b3d6ce8745acc52695e252bdb1531b6}{dht}->\hyperlink{struct_d_h_t_aa05050f86513ff53fe9da81f73c72267}{self\_secret\_key}, packet + 1 + crypto\_box\_NONCEBYTES);
324     \textcolor{keywordtype}{int} len = \hyperlink{crypto__core_8c_a824b257fcff74b9d17c5247223fbed29}{decrypt\_data\_symmetric}(shared\_key, packet + 1, packet + 1 + 
      crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES,
325                                      length - (1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES), 
      plain);
326 
327     \textcolor{keywordflow}{if} (len != length - (1 + crypto\_box\_NONCEBYTES + crypto\_box\_PUBLICKEYBYTES + crypto\_box\_MACBYTES))
328         \textcolor{keywordflow}{return} 1;
329 
330     \textcolor{keywordflow}{return} \hyperlink{onion_8c_a112ff3dd6d8a1e104516eb4b465fc2fa}{onion\_send\_1}(onion, plain, len, source, packet + 1);
331 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_ad1a4dfd05094ff479cda552ed94059f7_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_ad1a4dfd05094ff479cda552ed94059f7_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a6b9b6abcbb6fde502e7822236a978118}{\index{onion.\+c@{onion.\+c}!ip\+\_\+pack@{ip\+\_\+pack}}
\index{ip\+\_\+pack@{ip\+\_\+pack}!onion.\+c@{onion.\+c}}
\subsubsection[{ip\+\_\+pack}]{\setlength{\rightskip}{0pt plus 5cm}static void ip\+\_\+pack (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t $\ast$}]{data, }
\item[{{\bf I\+P}}]{source}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_a6b9b6abcbb6fde502e7822236a978118}


Definition at line 49 of file onion.\+c.



References I\+P\+::family, I\+P\+::ip4, I\+P\+::ip6, S\+I\+Z\+E\+\_\+\+I\+P4, S\+I\+Z\+E\+\_\+\+I\+P6, to\+\_\+net\+\_\+family(), T\+O\+X\+\_\+\+A\+F\+\_\+\+I\+N\+E\+T, T\+O\+X\+\_\+\+T\+C\+P\+\_\+\+I\+N\+E\+T, I\+P4\+::uint8, and I\+P6\+::uint8.



Referenced by ipport\+\_\+pack().


\begin{DoxyCode}
50 \{
51     \hyperlink{_d_h_t_8c_ae7f65a76f9c4b0093f45fc1777238459}{to\_net\_family}(&source);
52 
53     \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[0] = source.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family};
54 
55     \textcolor{keywordflow}{if} (source.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} == \hyperlink{_d_h_t_8h_ac35a63082a23b6ced97c0a3a24ba06be}{TOX\_AF\_INET} || source.\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} == 
      \hyperlink{_d_h_t_8h_ab59616c5422ae79ebc665059761879d5}{TOX\_TCP\_INET}) \{
56         memset(\hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + 1, 0, \hyperlink{network_8h_a5d7430ad26f80239b9fe1bbcd51b5ed2}{SIZE\_IP6});
57         memcpy(\hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + 1, source.\hyperlink{struct_i_p_aca19646000f55aa927406e68fc41ecf9}{ip4}.\hyperlink{union_i_p4_a73b9a57544f1edd6e2187aca636c75ef}{uint8}, \hyperlink{network_8h_af01e75c1c63a39bcd2aacdf3018b18c9}{SIZE\_IP4});
58     \} \textcolor{keywordflow}{else} \{
59         memcpy(\hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + 1, source.\hyperlink{struct_i_p_a14c606eb5ffb078c38ad854dc4e79507}{ip6}.\hyperlink{union_i_p6_a6b067d428eefbf1754aa09429b1ba524}{uint8}, \hyperlink{network_8h_a5d7430ad26f80239b9fe1bbcd51b5ed2}{SIZE\_IP6});
60     \}
61 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=241pt]{d4/d18/onion_8c_a6b9b6abcbb6fde502e7822236a978118_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a6b9b6abcbb6fde502e7822236a978118_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a0687fad9fd17ea53d6b84a6cfc7e0d78}{\index{onion.\+c@{onion.\+c}!ip\+\_\+unpack@{ip\+\_\+unpack}}
\index{ip\+\_\+unpack@{ip\+\_\+unpack}!onion.\+c@{onion.\+c}}
\subsubsection[{ip\+\_\+unpack}]{\setlength{\rightskip}{0pt plus 5cm}static int ip\+\_\+unpack (
\begin{DoxyParamCaption}
\item[{{\bf I\+P} $\ast$}]{target, }
\item[{const uint8\+\_\+t $\ast$}]{data, }
\item[{unsigned int}]{data\+\_\+size, }
\item[{\+\_\+\+Bool}]{disable\+\_\+family\+\_\+check}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_a0687fad9fd17ea53d6b84a6cfc7e0d78}


Definition at line 64 of file onion.\+c.



References I\+P\+::family, I\+P\+::ip4, I\+P\+::ip6, S\+I\+Z\+E\+\_\+\+I\+P4, S\+I\+Z\+E\+\_\+\+I\+P6, to\+\_\+host\+\_\+family(), T\+O\+X\+\_\+\+A\+F\+\_\+\+I\+N\+E\+T, T\+O\+X\+\_\+\+T\+C\+P\+\_\+\+I\+N\+E\+T, I\+P4\+::uint8, and I\+P6\+::uint8.



Referenced by ipport\+\_\+unpack().


\begin{DoxyCode}
65 \{
66     \textcolor{keywordflow}{if} (data\_size < (1 + \hyperlink{network_8h_a5d7430ad26f80239b9fe1bbcd51b5ed2}{SIZE\_IP6}))
67         \textcolor{keywordflow}{return} -1;
68 
69     target->\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} = \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[0];
70 
71     \textcolor{keywordflow}{if} (target->\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} == \hyperlink{_d_h_t_8h_ac35a63082a23b6ced97c0a3a24ba06be}{TOX\_AF\_INET} || target->\hyperlink{struct_i_p_adad4493a852deb413bb8c515368deaac}{family} == 
      \hyperlink{_d_h_t_8h_ab59616c5422ae79ebc665059761879d5}{TOX\_TCP\_INET}) \{
72         memcpy(target->\hyperlink{struct_i_p_aca19646000f55aa927406e68fc41ecf9}{ip4}.\hyperlink{union_i_p4_a73b9a57544f1edd6e2187aca636c75ef}{uint8}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + 1, \hyperlink{network_8h_af01e75c1c63a39bcd2aacdf3018b18c9}{SIZE\_IP4});
73     \} \textcolor{keywordflow}{else} \{
74         memcpy(target->\hyperlink{struct_i_p_a14c606eb5ffb078c38ad854dc4e79507}{ip6}.\hyperlink{union_i_p6_a6b067d428eefbf1754aa09429b1ba524}{uint8}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + 1, \hyperlink{network_8h_a5d7430ad26f80239b9fe1bbcd51b5ed2}{SIZE\_IP6});
75     \}
76 
77     \textcolor{keywordflow}{if} (!disable\_family\_check) \{
78         \textcolor{keywordflow}{return} \hyperlink{_d_h_t_8c_a74120ec4fc551572bff2a08436854c97}{to\_host\_family}(target);
79     \} \textcolor{keywordflow}{else} \{
80         \hyperlink{_d_h_t_8c_a74120ec4fc551572bff2a08436854c97}{to\_host\_family}(target);
81         \textcolor{keywordflow}{return} 0;
82     \}
83 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=257pt]{d4/d18/onion_8c_a0687fad9fd17ea53d6b84a6cfc7e0d78_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a0687fad9fd17ea53d6b84a6cfc7e0d78_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_ae9d8dde9317c06fe493658b8145de853}{\index{onion.\+c@{onion.\+c}!ipport\+\_\+pack@{ipport\+\_\+pack}}
\index{ipport\+\_\+pack@{ipport\+\_\+pack}!onion.\+c@{onion.\+c}}
\subsubsection[{ipport\+\_\+pack}]{\setlength{\rightskip}{0pt plus 5cm}static void ipport\+\_\+pack (
\begin{DoxyParamCaption}
\item[{uint8\+\_\+t $\ast$}]{data, }
\item[{const {\bf I\+P\+\_\+\+Port} $\ast$}]{source}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_ae9d8dde9317c06fe493658b8145de853}


Definition at line 85 of file onion.\+c.



References I\+P\+\_\+\+Port\+::ip, ip\+\_\+pack(), I\+P\+\_\+\+Port\+::port, S\+I\+Z\+E\+\_\+\+I\+P, and S\+I\+Z\+E\+\_\+\+P\+O\+R\+T.



Referenced by create\+\_\+onion\+\_\+packet(), create\+\_\+onion\+\_\+packet\+\_\+tcp(), handle\+\_\+send\+\_\+1(), handle\+\_\+send\+\_\+2(), and onion\+\_\+send\+\_\+1().


\begin{DoxyCode}
86 \{
87     \hyperlink{onion_8c_a6b9b6abcbb6fde502e7822236a978118}{ip\_pack}(\hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}, source->\hyperlink{struct_i_p___port_a0c6193a337a223c63411b2fe722d79ec}{ip});
88     memcpy(\hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + \hyperlink{network_8h_a347bab05abec85d23b5207309a5223b8}{SIZE\_IP}, &source->\hyperlink{struct_i_p___port_a8e0798404bf2cf5dabb84c5ba9a4f236}{port}, \hyperlink{network_8h_a7771606fa737c038bcad05c8926b9ddd}{SIZE\_PORT});
89 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=344pt]{d4/d18/onion_8c_ae9d8dde9317c06fe493658b8145de853_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_ae9d8dde9317c06fe493658b8145de853_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a5134cc15375a918b584e3c408e038331}{\index{onion.\+c@{onion.\+c}!ipport\+\_\+unpack@{ipport\+\_\+unpack}}
\index{ipport\+\_\+unpack@{ipport\+\_\+unpack}!onion.\+c@{onion.\+c}}
\subsubsection[{ipport\+\_\+unpack}]{\setlength{\rightskip}{0pt plus 5cm}static int ipport\+\_\+unpack (
\begin{DoxyParamCaption}
\item[{{\bf I\+P\+\_\+\+Port} $\ast$}]{target, }
\item[{const uint8\+\_\+t $\ast$}]{data, }
\item[{unsigned int}]{data\+\_\+size, }
\item[{\+\_\+\+Bool}]{disable\+\_\+family\+\_\+check}
\end{DoxyParamCaption}
)\hspace{0.3cm}{\ttfamily [static]}}}\label{onion_8c_a5134cc15375a918b584e3c408e038331}


Definition at line 92 of file onion.\+c.



References I\+P\+\_\+\+Port\+::ip, ip\+\_\+unpack(), I\+P\+\_\+\+Port\+::port, S\+I\+Z\+E\+\_\+\+I\+P, and S\+I\+Z\+E\+\_\+\+P\+O\+R\+T.



Referenced by handle\+\_\+recv\+\_\+1(), handle\+\_\+recv\+\_\+2(), handle\+\_\+recv\+\_\+3(), handle\+\_\+send\+\_\+1(), handle\+\_\+send\+\_\+2(), and onion\+\_\+send\+\_\+1().


\begin{DoxyCode}
93 \{
94     \textcolor{keywordflow}{if} (data\_size < (\hyperlink{network_8h_a347bab05abec85d23b5207309a5223b8}{SIZE\_IP} + \hyperlink{network_8h_a7771606fa737c038bcad05c8926b9ddd}{SIZE\_PORT}))
95         \textcolor{keywordflow}{return} -1;
96 
97     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a0687fad9fd17ea53d6b84a6cfc7e0d78}{ip\_unpack}(&target->\hyperlink{struct_i_p___port_a0c6193a337a223c63411b2fe722d79ec}{ip}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}, data\_size, disable\_family\_check) == -1)
98         \textcolor{keywordflow}{return} -1;
99 
100     memcpy(&target->\hyperlink{struct_i_p___port_a8e0798404bf2cf5dabb84c5ba9a4f236}{port}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data} + \hyperlink{network_8h_a347bab05abec85d23b5207309a5223b8}{SIZE\_IP}, \hyperlink{network_8h_a7771606fa737c038bcad05c8926b9ddd}{SIZE\_PORT});
101     \textcolor{keywordflow}{return} 0;
102 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a5134cc15375a918b584e3c408e038331_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a5134cc15375a918b584e3c408e038331_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a301c5cb9db2604dc1ea885c3a2cf8408}{\index{onion.\+c@{onion.\+c}!kill\+\_\+onion@{kill\+\_\+onion}}
\index{kill\+\_\+onion@{kill\+\_\+onion}!onion.\+c@{onion.\+c}}
\subsubsection[{kill\+\_\+onion}]{\setlength{\rightskip}{0pt plus 5cm}void kill\+\_\+onion (
\begin{DoxyParamCaption}
\item[{{\bf Onion} $\ast$}]{onion}
\end{DoxyParamCaption}
)}}\label{onion_8c_a301c5cb9db2604dc1ea885c3a2cf8408}


Definition at line 608 of file onion.\+c.



References Onion\+::net, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+1, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+2, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+3, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+1, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+2, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+\+I\+N\+I\+T\+I\+A\+L, and networking\+\_\+registerhandler().



Referenced by kill\+\_\+messenger(), kill\+\_\+onions(), new\+\_\+messenger(), and S\+T\+A\+R\+T\+\_\+\+T\+E\+S\+T().


\begin{DoxyCode}
609 \{
610     \textcolor{keywordflow}{if} (onion == NULL)
611         \textcolor{keywordflow}{return};
612 
613     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_a6d89eb02b93f686802f9d3e5e7f7ab2d}{NET\_PACKET\_ONION\_SEND\_INITIAL}, NULL, NULL);
614     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_af35e3289fe8c4324b7a07655952f5eab}{NET\_PACKET\_ONION\_SEND\_1}, NULL, NULL);
615     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_ac537a2a6be093500c4d362012515b565}{NET\_PACKET\_ONION\_SEND\_2}, NULL, NULL);
616 
617     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_a7ef70febad8b27e23b73db25d78cd666}{NET\_PACKET\_ONION\_RECV\_3}, NULL, NULL);
618     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_a27ee7b36bdc6b4fb72e704fee4dc392b}{NET\_PACKET\_ONION\_RECV\_2}, NULL, NULL);
619     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_ac2df6c149caae49d80e5217d480ae839}{NET\_PACKET\_ONION\_RECV\_1}, NULL, NULL);
620 
621     free(onion);
622 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=306pt]{d4/d18/onion_8c_a301c5cb9db2604dc1ea885c3a2cf8408_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a301c5cb9db2604dc1ea885c3a2cf8408_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a71877ec5931feec418ed1ae10b0963d8}{\index{onion.\+c@{onion.\+c}!new\+\_\+onion@{new\+\_\+onion}}
\index{new\+\_\+onion@{new\+\_\+onion}!onion.\+c@{onion.\+c}}
\subsubsection[{new\+\_\+onion}]{\setlength{\rightskip}{0pt plus 5cm}{\bf Onion}$\ast$ new\+\_\+onion (
\begin{DoxyParamCaption}
\item[{{\bf D\+H\+T} $\ast$}]{dht}
\end{DoxyParamCaption}
)}}\label{onion_8c_a71877ec5931feec418ed1ae10b0963d8}


Definition at line 582 of file onion.\+c.



References Onion\+::dht, handle\+\_\+recv\+\_\+1(), handle\+\_\+recv\+\_\+2(), handle\+\_\+recv\+\_\+3(), handle\+\_\+send\+\_\+1(), handle\+\_\+send\+\_\+2(), handle\+\_\+send\+\_\+initial(), Onion\+::net, D\+H\+T\+::net, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+1, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+2, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+3, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+1, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+2, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+\+I\+N\+I\+T\+I\+A\+L, networking\+\_\+registerhandler(), new\+\_\+symmetric\+\_\+key(), Onion\+::secret\+\_\+symmetric\+\_\+key, Onion\+::timestamp, and unix\+\_\+time().



Referenced by main(), new\+\_\+messenger(), new\+\_\+onions(), and S\+T\+A\+R\+T\+\_\+\+T\+E\+S\+T().


\begin{DoxyCode}
583 \{
584     \textcolor{keywordflow}{if} (dht == NULL)
585         \textcolor{keywordflow}{return} NULL;
586 
587     \hyperlink{struct_onion}{Onion} *onion = calloc(1, \textcolor{keyword}{sizeof}(\hyperlink{struct_onion}{Onion}));
588 
589     \textcolor{keywordflow}{if} (onion == NULL)
590         \textcolor{keywordflow}{return} NULL;
591 
592     onion->\hyperlink{struct_onion_a8b3d6ce8745acc52695e252bdb1531b6}{dht} = dht;
593     onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net} = dht->\hyperlink{struct_d_h_t_aa14ea2f67950f57fe4235d7375a2216c}{net};
594     \hyperlink{crypto__core_8c_a89b4a1a4a7d8bfabdf0e1b60f074e531}{new\_symmetric\_key}(onion->\hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key});
595     onion->\hyperlink{struct_onion_a465bef81f6478756e5443025b1f2ddfa}{timestamp} = \hyperlink{util_8c_ac958d9f8847cb8039444bfa3d304233a}{unix\_time}();
596 
597     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_a6d89eb02b93f686802f9d3e5e7f7ab2d}{NET\_PACKET\_ONION\_SEND\_INITIAL}, &\hyperlink{onion_8c_ad1a4dfd05094ff479cda552ed94059f7}{handle\_send\_initial}, onion)
      ;
598     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_af35e3289fe8c4324b7a07655952f5eab}{NET\_PACKET\_ONION\_SEND\_1}, &\hyperlink{onion_8c_af8b808b43786292e39b10d6e05ba1cb7}{handle\_send\_1}, onion);
599     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_ac537a2a6be093500c4d362012515b565}{NET\_PACKET\_ONION\_SEND\_2}, &\hyperlink{onion_8c_a60a847c1f3f33f8e2efdc13ede5f7ecc}{handle\_send\_2}, onion);
600 
601     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_a7ef70febad8b27e23b73db25d78cd666}{NET\_PACKET\_ONION\_RECV\_3}, &\hyperlink{onion_8c_aad67ae9de051b78358faf690eaa03099}{handle\_recv\_3}, onion);
602     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_a27ee7b36bdc6b4fb72e704fee4dc392b}{NET\_PACKET\_ONION\_RECV\_2}, &\hyperlink{onion_8c_a2efffc024cccd53f433718980ccf4541}{handle\_recv\_2}, onion);
603     \hyperlink{network_8c_a230a192ca9463ec4985d4f86de439733}{networking\_registerhandler}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, 
      \hyperlink{network_8h_ac2df6c149caae49d80e5217d480ae839}{NET\_PACKET\_ONION\_RECV\_1}, &\hyperlink{onion_8c_a733219ca8d321d01a999f10447b2e301}{handle\_recv\_1}, onion);
604 
605     \textcolor{keywordflow}{return} onion;
606 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a71877ec5931feec418ed1ae10b0963d8_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a71877ec5931feec418ed1ae10b0963d8_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a0037270c6e9bca59c4e0cd118ebfa593}{\index{onion.\+c@{onion.\+c}!onion\+\_\+path\+\_\+to\+\_\+nodes@{onion\+\_\+path\+\_\+to\+\_\+nodes}}
\index{onion\+\_\+path\+\_\+to\+\_\+nodes@{onion\+\_\+path\+\_\+to\+\_\+nodes}!onion.\+c@{onion.\+c}}
\subsubsection[{onion\+\_\+path\+\_\+to\+\_\+nodes}]{\setlength{\rightskip}{0pt plus 5cm}int onion\+\_\+path\+\_\+to\+\_\+nodes (
\begin{DoxyParamCaption}
\item[{{\bf Node\+\_\+format} $\ast$}]{nodes, }
\item[{unsigned int}]{num\+\_\+nodes, }
\item[{const {\bf Onion\+\_\+\+Path} $\ast$}]{path}
\end{DoxyParamCaption}
)}}\label{onion_8c_a0037270c6e9bca59c4e0cd118ebfa593}


Definition at line 149 of file onion.\+c.



References Node\+\_\+format\+::ip\+\_\+port, Onion\+\_\+\+Path\+::ip\+\_\+port1, Onion\+\_\+\+Path\+::ip\+\_\+port2, Onion\+\_\+\+Path\+::ip\+\_\+port3, Onion\+\_\+\+Path\+::node\+\_\+public\+\_\+key1, Onion\+\_\+\+Path\+::node\+\_\+public\+\_\+key2, Onion\+\_\+\+Path\+::node\+\_\+public\+\_\+key3, O\+N\+I\+O\+N\+\_\+\+P\+A\+T\+H\+\_\+\+L\+E\+N\+G\+T\+H, and make-\/funny-\/savefile\+::public\+\_\+key.



Referenced by set\+\_\+path\+\_\+timeouts().


\begin{DoxyCode}
150 \{
151     \textcolor{keywordflow}{if} (num\_nodes < \hyperlink{onion_8h_abe0dd1f2cbadfda52425e7c2fed7d8c3}{ONION\_PATH\_LENGTH})
152         \textcolor{keywordflow}{return} -1;
153 
154     nodes[0].\hyperlink{struct_node__format_a86e2a5a56c0dd22df6e8b8a10e40f9e4}{ip\_port} = path->\hyperlink{struct_onion___path_ad7670c0a1a9d05b2a807a9c1a7950b79}{ip\_port1};
155     nodes[1].\hyperlink{struct_node__format_a86e2a5a56c0dd22df6e8b8a10e40f9e4}{ip\_port} = path->\hyperlink{struct_onion___path_adcf789584e4efc296bc6f915d3e2e9f9}{ip\_port2};
156     nodes[2].\hyperlink{struct_node__format_a86e2a5a56c0dd22df6e8b8a10e40f9e4}{ip\_port} = path->\hyperlink{struct_onion___path_aef20a4d17084ae724f2e496f8f7a106a}{ip\_port3};
157 
158     memcpy(nodes[0].\hyperlink{namespacemake-funny-savefile_a6734667aeff5c30ad9e5624ccb556a87}{public\_key}, path->\hyperlink{struct_onion___path_a38f4e3f7780648cf74f808d7942113d8}{node\_public\_key1}, crypto\_box\_PUBLICKEYBYTES
      );
159     memcpy(nodes[1].\hyperlink{namespacemake-funny-savefile_a6734667aeff5c30ad9e5624ccb556a87}{public\_key}, path->\hyperlink{struct_onion___path_adc5a9730c2f43085e83ece3257af154a}{node\_public\_key2}, crypto\_box\_PUBLICKEYBYTES
      );
160     memcpy(nodes[2].\hyperlink{namespacemake-funny-savefile_a6734667aeff5c30ad9e5624ccb556a87}{public\_key}, path->\hyperlink{struct_onion___path_a4725b29fc0349714fa0ab0938844cf19}{node\_public\_key3}, crypto\_box\_PUBLICKEYBYTES
      );
161     \textcolor{keywordflow}{return} 0;
162 \}
\end{DoxyCode}


Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a0037270c6e9bca59c4e0cd118ebfa593_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a112ff3dd6d8a1e104516eb4b465fc2fa}{\index{onion.\+c@{onion.\+c}!onion\+\_\+send\+\_\+1@{onion\+\_\+send\+\_\+1}}
\index{onion\+\_\+send\+\_\+1@{onion\+\_\+send\+\_\+1}!onion.\+c@{onion.\+c}}
\subsubsection[{onion\+\_\+send\+\_\+1}]{\setlength{\rightskip}{0pt plus 5cm}int onion\+\_\+send\+\_\+1 (
\begin{DoxyParamCaption}
\item[{const {\bf Onion} $\ast$}]{onion, }
\item[{const uint8\+\_\+t $\ast$}]{plain, }
\item[{uint16\+\_\+t}]{len, }
\item[{{\bf I\+P\+\_\+\+Port}}]{source, }
\item[{const uint8\+\_\+t $\ast$}]{nonce}
\end{DoxyParamCaption}
)}}\label{onion_8c_a112ff3dd6d8a1e104516eb4b465fc2fa}


Definition at line 333 of file onion.\+c.



References make-\/funny-\/savefile\+::data, encrypt\+\_\+data\+\_\+symmetric(), ipport\+\_\+pack(), ipport\+\_\+unpack(), Onion\+::net, N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+S\+E\+N\+D\+\_\+1, new\+\_\+nonce(), O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, O\+N\+I\+O\+N\+\_\+\+R\+E\+T\+U\+R\+N\+\_\+1, Onion\+::secret\+\_\+symmetric\+\_\+key, S\+E\+N\+D\+\_\+\+B\+A\+S\+E, sendpacket(), and S\+I\+Z\+E\+\_\+\+I\+P\+P\+O\+R\+T.



Referenced by handle\+\_\+send\+\_\+initial(), and handle\+\_\+\+T\+C\+P\+\_\+packet().


\begin{DoxyCode}
334 \{
335     \textcolor{keywordflow}{if} (len > \hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE} + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} - (1 + 
      crypto\_box\_NONCEBYTES + \hyperlink{onion_8h_a45874dbad3133dc676900407c0672660}{ONION\_RETURN\_1}))
336         \textcolor{keywordflow}{return} 1;
337 
338     \textcolor{keywordflow}{if} (len <= \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + \hyperlink{onion_8c_ad40bb79953288e33ace996a24cc7c86f}{SEND\_BASE} * 2)
339         \textcolor{keywordflow}{return} 1;
340 
341     \hyperlink{struct_i_p___port}{IP\_Port} send\_to;
342 
343     \textcolor{keywordflow}{if} (\hyperlink{onion_8c_a5134cc15375a918b584e3c408e038331}{ipport\_unpack}(&send\_to, plain, len, 0) == -1)
344         \textcolor{keywordflow}{return} 1;
345 
346     uint8\_t ip\_port[\hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}];
347     \hyperlink{onion_8c_ae9d8dde9317c06fe493658b8145de853}{ipport\_pack}(ip\_port, &source);
348 
349     uint8\_t \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
350     data[0] = \hyperlink{network_8h_af35e3289fe8c4324b7a07655952f5eab}{NET\_PACKET\_ONION\_SEND\_1};
351     memcpy(data + 1, \hyperlink{crypto__test_8c_a7932c523f7065073a396e571319201ce}{nonce}, crypto\_box\_NONCEBYTES);
352     memcpy(data + 1 + crypto\_box\_NONCEBYTES, plain + \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT}, len - 
      \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
353     uint16\_t data\_len = 1 + crypto\_box\_NONCEBYTES + (len - \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT});
354     uint8\_t *ret\_part = data + data\_len;
355     \hyperlink{crypto__core_8c_a8b1033efb47c625779d11be7d8eb9e24}{new\_nonce}(ret\_part);
356     len = \hyperlink{crypto__core_8c_a81efc0a4a6e0efe372651e26e342a6e5}{encrypt\_data\_symmetric}(onion->
      \hyperlink{struct_onion_ab9f2ff47bc0b1e5110202a6e4be86390}{secret\_symmetric\_key}, ret\_part, ip\_port, \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT},
357                                  ret\_part + crypto\_box\_NONCEBYTES);
358 
359     \textcolor{keywordflow}{if} (len != \hyperlink{network_8h_a42c0a5872a869ac0cfd8200935ed49ee}{SIZE\_IPPORT} + crypto\_box\_MACBYTES)
360         \textcolor{keywordflow}{return} 1;
361 
362     data\_len += crypto\_box\_NONCEBYTES + len;
363 
364     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(onion->\hyperlink{struct_onion_aa14ea2f67950f57fe4235d7375a2216c}{net}, send\_to, data, data\_len) != data\_len)
365         \textcolor{keywordflow}{return} 1;
366 
367     \textcolor{keywordflow}{return} 0;
368 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a112ff3dd6d8a1e104516eb4b465fc2fa_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a112ff3dd6d8a1e104516eb4b465fc2fa_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_af06edfff31b42d31803e24fc7f47d365}{\index{onion.\+c@{onion.\+c}!send\+\_\+onion\+\_\+packet@{send\+\_\+onion\+\_\+packet}}
\index{send\+\_\+onion\+\_\+packet@{send\+\_\+onion\+\_\+packet}!onion.\+c@{onion.\+c}}
\subsubsection[{send\+\_\+onion\+\_\+packet}]{\setlength{\rightskip}{0pt plus 5cm}int send\+\_\+onion\+\_\+packet (
\begin{DoxyParamCaption}
\item[{{\bf Networking\+\_\+\+Core} $\ast$}]{net, }
\item[{const {\bf Onion\+\_\+\+Path} $\ast$}]{path, }
\item[{{\bf I\+P\+\_\+\+Port}}]{dest, }
\item[{const uint8\+\_\+t $\ast$}]{data, }
\item[{uint16\+\_\+t}]{length}
\end{DoxyParamCaption}
)}}\label{onion_8c_af06edfff31b42d31803e24fc7f47d365}


Definition at line 273 of file onion.\+c.



References create\+\_\+onion\+\_\+packet(), Onion\+\_\+\+Path\+::ip\+\_\+port1, O\+N\+I\+O\+N\+\_\+\+M\+A\+X\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+S\+I\+Z\+E, and sendpacket().



Referenced by S\+T\+A\+R\+T\+\_\+\+T\+E\+S\+T().


\begin{DoxyCode}
274 \{
275     uint8\_t packet[\hyperlink{onion_8h_a48fdc4b34dbecf0a3417a557b83a4ff4}{ONION\_MAX\_PACKET\_SIZE}];
276     \textcolor{keywordtype}{int} len = \hyperlink{onion_8c_a34cf7934690ab5336b99844383a445a8}{create\_onion\_packet}(packet, \textcolor{keyword}{sizeof}(packet), path, dest, 
      \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}, length);
277 
278     \textcolor{keywordflow}{if} (len == -1)
279         \textcolor{keywordflow}{return} -1;
280 
281     \textcolor{keywordflow}{if} (\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(net, path->\hyperlink{struct_onion___path_ad7670c0a1a9d05b2a807a9c1a7950b79}{ip\_port1}, packet, len) != len)
282         \textcolor{keywordflow}{return} -1;
283 
284     \textcolor{keywordflow}{return} 0;
285 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_af06edfff31b42d31803e24fc7f47d365_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=297pt]{d4/d18/onion_8c_af06edfff31b42d31803e24fc7f47d365_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_a8d81f915fcff64bfe2508296d325f7d4}{\index{onion.\+c@{onion.\+c}!send\+\_\+onion\+\_\+response@{send\+\_\+onion\+\_\+response}}
\index{send\+\_\+onion\+\_\+response@{send\+\_\+onion\+\_\+response}!onion.\+c@{onion.\+c}}
\subsubsection[{send\+\_\+onion\+\_\+response}]{\setlength{\rightskip}{0pt plus 5cm}int send\+\_\+onion\+\_\+response (
\begin{DoxyParamCaption}
\item[{{\bf Networking\+\_\+\+Core} $\ast$}]{net, }
\item[{{\bf I\+P\+\_\+\+Port}}]{dest, }
\item[{const uint8\+\_\+t $\ast$}]{data, }
\item[{uint16\+\_\+t}]{length, }
\item[{const uint8\+\_\+t $\ast$}]{ret}
\end{DoxyParamCaption}
)}}\label{onion_8c_a8d81f915fcff64bfe2508296d325f7d4}


Definition at line 293 of file onion.\+c.



References N\+E\+T\+\_\+\+P\+A\+C\+K\+E\+T\+\_\+\+O\+N\+I\+O\+N\+\_\+\+R\+E\+C\+V\+\_\+3, O\+N\+I\+O\+N\+\_\+\+R\+E\+S\+P\+O\+N\+S\+E\+\_\+\+M\+A\+X\+\_\+\+D\+A\+T\+A\+\_\+\+S\+I\+Z\+E, R\+E\+T\+U\+R\+N\+\_\+3, and sendpacket().



Referenced by handle\+\_\+announce\+\_\+request(), handle\+\_\+data\+\_\+request(), and handle\+\_\+test\+\_\+1().


\begin{DoxyCode}
294 \{
295     \textcolor{keywordflow}{if} (length > \hyperlink{onion_8h_aea8fcee93c08e278868fb377062789e9}{ONION\_RESPONSE\_MAX\_DATA\_SIZE} || length == 0)
296         \textcolor{keywordflow}{return} -1;
297 
298     uint8\_t packet[1 + \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3} + length];
299     packet[0] = \hyperlink{network_8h_a7ef70febad8b27e23b73db25d78cd666}{NET\_PACKET\_ONION\_RECV\_3};
300     memcpy(packet + 1, ret, \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3});
301     memcpy(packet + 1 + \hyperlink{onion_8c_a06d1047d4f4a1f8a3d2239594e2da9fc}{RETURN\_3}, \hyperlink{namespacemake-funny-savefile_aa7a0efb8690a34f61a95b00cc723ca27}{data}, length);
302 
303     \textcolor{keywordflow}{if} ((uint32\_t)\hyperlink{network_8c_a7b90f87f3ba60cc5c66dd6dd77cd5cb1}{sendpacket}(net, dest, packet, \textcolor{keyword}{sizeof}(packet)) != \textcolor{keyword}{sizeof}(packet))
304         \textcolor{keywordflow}{return} -1;
305 
306     \textcolor{keywordflow}{return} 0;
307 \}
\end{DoxyCode}


Here is the call graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=294pt]{d4/d18/onion_8c_a8d81f915fcff64bfe2508296d325f7d4_cgraph}
\end{center}
\end{figure}




Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_a8d81f915fcff64bfe2508296d325f7d4_icgraph}
\end{center}
\end{figure}


\hypertarget{onion_8c_ae1b8e562e22bd28deca3f98dace1a421}{\index{onion.\+c@{onion.\+c}!set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1@{set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1}}
\index{set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1@{set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1}!onion.\+c@{onion.\+c}}
\subsubsection[{set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1}]{\setlength{\rightskip}{0pt plus 5cm}void set\+\_\+callback\+\_\+handle\+\_\+recv\+\_\+1 (
\begin{DoxyParamCaption}
\item[{{\bf Onion} $\ast$}]{onion, }
\item[{int($\ast$)(void $\ast$, {\bf I\+P\+\_\+\+Port}, const uint8\+\_\+t $\ast$, uint16\+\_\+t)}]{function, }
\item[{void $\ast$}]{object}
\end{DoxyParamCaption}
)}}\label{onion_8c_ae1b8e562e22bd28deca3f98dace1a421}


Definition at line 576 of file onion.\+c.



References Onion\+::callback\+\_\+object, and Onion\+::recv\+\_\+1\+\_\+function.



Referenced by kill\+\_\+\+T\+C\+P\+\_\+server(), and new\+\_\+\+T\+C\+P\+\_\+server().


\begin{DoxyCode}
577 \{
578     onion->\hyperlink{struct_onion_a980753d0df6688333680e95f637eb7a7}{recv\_1\_function} = \textcolor{keyword}{function};
579     onion->\hyperlink{struct_onion_aa30dff385b8f119ddb95900b2a250a08}{callback\_object} = object;
580 \}
\end{DoxyCode}


Here is the caller graph for this function\+:
\nopagebreak
\begin{figure}[H]
\begin{center}
\leavevmode
\includegraphics[width=350pt]{d4/d18/onion_8c_ae1b8e562e22bd28deca3f98dace1a421_icgraph}
\end{center}
\end{figure}


